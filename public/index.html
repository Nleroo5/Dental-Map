<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Dental Market Map — Established Shot</title>

  <!-- Brand fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Young+Serif&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Styling -->
  <style>
    :root{
      --navy:#012E40;
      --gold:#F2A922;
      --teal:#05908C;
      --mint:#85C7B3;
      --foam:#EEF4D9;
      --ink:#0b1720;
      --card:#06222e;
      --ring:rgba(242,169,34,.5);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:#e9f3f3;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(5,144,140,.35), transparent 60%),
        radial-gradient(900px 600px at 110% 40%, rgba(242,169,34,.18), transparent 60%),
        linear-gradient(180deg, #031923 0%, #03161d 100%);
    }
    .wrap{
      max-width:1200px;margin:0 auto;padding:24px 16px 40px;
    }
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px;
    }
    .brand{
      display:flex;align-items:center;gap:12px;
    }
    .logo-dot{
      width:14px;height:14px;border-radius:50%;background:var(--gold);box-shadow:0 0 0 4px rgba(242,169,34,.2);
    }
    .title{font-family:"Young Serif",serif;font-size:22px;letter-spacing:.2px}
    .toolbar{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
      background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);
      padding:10px;border-radius:12px;
      box-shadow:0 6px 16px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.04);
    }
    input[type="text"]{
      width:360px;max-width:80vw;
      background:#081f29;border:1px solid rgba(255,255,255,.12);color:#e6f1f1;
      padding:10px 12px;border-radius:10px;outline:0;
    }
    select,button{
      appearance:none;
      background:#092431;border:1px solid rgba(255,255,255,.12);color:#e6f1f1;
      padding:10px 12px;border-radius:10px;cursor:pointer;
    }
    button.primary{
      background:var(--gold);border-color:var(--gold);color:#0d1012;font-weight:700;
    }
    .grid{
      display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin-top:10px;
    }
    #map{
      width:100%;height:75vh;min-height:560px;border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 8px 24px rgba(0,0,0,.35);
      overflow:hidden;background:#05171f;
    }
    .panel{
      display:flex;flex-direction:column;gap:12px;
    }
    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:14px 14px;
      box-shadow:0 10px 24px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .card h3{
      margin:0 0 8px 0;font-family:"Young Serif",serif;font-weight:400;color:#f3f7f6
    }
    .statrow{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;font-weight:600;background:#0b2a35;border:1px solid rgba(255,255,255,.10)
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.teal{background:var(--teal)}
    .dot.navy{background:#0c3141}
    .badge{
      padding:8px 12px;border-radius:10px;font-weight:700;letter-spacing:.2px;
      background:#0b2a35;border:1px solid rgba(255,255,255,.1);
    }
    .badge.low{background:rgba(5,144,140,.15);border-color:rgba(5,144,140,.35);color:#b8ffef}
    .badge.med{background:rgba(242,169,34,.12);border-color:rgba(242,169,34,.45);color:#ffe9b6}
    .badge.high{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.22);color:#f4f7f8}
    .meta{color:#cfe8e3;font-size:13px;opacity:.85}
    .footer-note{color:#a8c7c0;font-size:12px;opacity:.8}
    .ai{min-height:180px;white-space:pre-wrap;line-height:1.45;}
    .loading{opacity:.6}
    @media (max-width:980px){
      .grid{grid-template-columns:1fr;gap:12px}
      #map{min-height:420px;height:60vh}
      input[type="text"]{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo-dot"></div>
        <div class="title">Established Shot — Dental Market Map</div>
      </div>
      <div class="toolbar">
        <input id="search" type="text" placeholder="Search dental practice or address…" />
        <select id="radius">
          <option value="3">3 mi</option>
          <option value="5" selected>5 mi</option>
          <option value="10">10 mi</option>
        </select>
        <button id="go" class="primary">Analyze</button>
      </div>
    </header>

    <div class="grid">
      <div id="map"></div>

      <div class="panel">
        <div class="card">
          <h3>Practice</h3>
          <div id="practiceName" class="meta">Select a practice to begin.</div>
          <div id="practiceAddr" class="meta"></div>
          <div id="practiceRating" class="meta"></div>
        </div>

        <div class="card">
          <h3>Competition Snapshot</h3>
          <div class="statrow">
            <span class="chip"><span class="dot teal"></span><span id="dentistCount">0</span>&nbsp;Dentists</span>
            <span class="chip"><span class="dot navy"></span><span id="orthoCount">0</span>&nbsp;Orthodontists</span>
            <span class="chip"><span id="invisCount">0</span>&nbsp;Invisalign mentions</span>
            <span class="chip"><span id="totalCount">0</span>&nbsp;Total</span>
          </div>
          <div style="margin-top:10px">
            <span id="densityBadge" class="badge">Density — n/a</span>
          </div>
          <div class="meta" style="margin-top:8px" id="nearestMeta"></div>
        </div>

        <div class="card">
          <h3>AI Insights</h3>
          <div id="ai" class="ai">Insights appear here after you run an analysis.</div>
          <div class="footer-note">Your AI key stays server-side. We never expose it in the browser.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Google Maps (Places + Geometry). Replace key: -->
  <script>
    window.__GMAPS_API_KEY__ = "AIzaSyDkSEjq4ZORmiV2yYDC72m0iJYTBn4Vr3o";
  </script>
  <script>
    (function loadGmaps(){
      const s = document.createElement('script');
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(window.__GMAPS_API_KEY__)}&libraries=places,geometry&callback=initMap`;
      s.async = true; s.defer = true;
      document.head.appendChild(s);
    })();
  </script>

  <script>
  // ---------- Globals & helpers
  const BRAND = { navy:"#012E40", gold:"#F2A922", teal:"#05908C" };
  const $ = (id)=>document.getElementById(id);

  let map, placesService, mainMarker, radiusCircle, infoWin;
  let competitorMarkers = [];
  let selectedPlace = null;

  // ---------- Google callback
  window.initMap = function(){
    const center = { lat: 33.7488, lng: -84.3877 }; // Atlanta default
    map = new google.maps.Map(document.getElementById('map'), {
      center, zoom: 10, disableDefaultUI: true,
      styles:[{featureType:"poi",stylers:[{visibility:"off"}]}]
    });
    placesService = new google.maps.places.PlacesService(map);
    infoWin = new google.maps.InfoWindow();

    // Autocomplete on the input
    const ac = new google.maps.places.Autocomplete($('search'), {
      fields: ["place_id","name","formatted_address","geometry"],
      types: ["establishment"]
    });

    ac.addListener('place_changed', ()=>{
      const place = ac.getPlace();
      if(!place || !place.geometry) return;
      selectedPlace = place;
      $('practiceName').textContent = place.name || '—';
      $('practiceAddr').textContent = place.formatted_address || '';
      $('practiceRating').textContent = 'Fetching Google rating…';
      centerOn(place.geometry.location);
      fetchPracticeDetails(place.place_id);
    });

    $('go').addEventListener('click', ()=>{
      if(!selectedPlace){ $('ai').textContent = 'Please choose a practice first.'; return; }
      runAnalysis(selectedPlace);
    });
    $('search').addEventListener('keydown', (e)=>{ if(e.key==='Enter') $('go').click(); });
  };

  function centerOn(latlng){
    if(mainMarker) mainMarker.setMap(null);
    if(radiusCircle) radiusCircle.setMap(null);

    mainMarker = new google.maps.Marker({
      position: latlng, map, title: 'Selected Practice',
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor: BRAND.teal, fillOpacity: .95,
        strokeColor: "#003e4f", strokeWeight: 2, scale: 8
      }
    });

    const miles = +$('radius').value;
    radiusCircle = new google.maps.Circle({
      strokeColor: BRAND.gold, strokeOpacity: 0.9, strokeWeight: 1.5,
      fillColor: BRAND.gold, fillOpacity: 0.06, map,
      center: latlng, radius: miles * 1609.34
    });

    map.fitBounds(radiusCircle.getBounds());
  }

  function fetchPracticeDetails(placeId){
    placesService.getDetails({
      placeId, fields:["name","formatted_address","rating","user_ratings_total","geometry"]
    }, (res, status)=>{
      if(status!==google.maps.places.PlacesServiceStatus.OK || !res){
        $('practiceRating').textContent = 'Rating: n/a';
        return;
      }
      const r = res.rating ?? '—';
      const n = res.user_ratings_total ?? 0;
      $('practiceRating').textContent = `Google rating: ${r} (${n} reviews)`;
    });
  }

  // -------- Paginated Nearby & Text Searches
  function nearbyPaged(opts, max = 60){
    return new Promise((resolve) => {
      const acc = [];
      let resolved = false;
      const cb = (results, status, pagination) => {
        if (status !== google.maps.places.PlacesServiceStatus.OK || !Array.isArray(results)) {
          if (!resolved) resolve(acc);
          return;
        }
        acc.push(...results);
        if (pagination && pagination.hasNextPage && acc.length < max) {
          setTimeout(() => pagination.nextPage(), 1200);
        } else if (!resolved) {
          resolved = true;
          resolve(acc.slice(0, max));
        }
      };
      placesService.nearbySearch(opts, cb);
    });
  }

  function textSearchPaged(opts, max = 40){
    return new Promise((resolve) => {
      const acc = [];
      let resolved = false;
      const cb = (results, status, pagination) => {
        if (status !== google.maps.places.PlacesServiceStatus.OK || !Array.isArray(results)) {
          if (!resolved) resolve(acc);
          return;
        }
        acc.push(...results);
        if (pagination && pagination.hasNextPage && acc.length < max) {
          setTimeout(() => pagination.nextPage(), 1200);
        } else if (!resolved) {
          resolved = true;
          resolve(acc.slice(0, max));
        }
      };
      placesService.textSearch(opts, cb);
    });
  }

  function openInfo(marker, place){
    const r = (place.rating != null) ? `${place.rating}★` : 'n/a';
    const n = (place.user_ratings_total != null) ? `(${place.user_ratings_total})` : '';
    const html = `<div style="min-width:200px">
        <div style="font-weight:700;margin-bottom:4px">${place.name || 'Practice'}</div>
        <div style="opacity:.85">Google rating: ${r} ${n}</div>
      </div>`;
    infoWin.setContent(html);
    infoWin.open({ map, anchor: marker });
  }

  async function runAnalysis(place){
    $('ai').classList.add('loading');
    $('ai').textContent = 'Analyzing area…';

    const miles = +$('radius').value;
    const center = place.geometry.location;
    const centerLL = { lat:center.lat(), lng:center.lng() };

    // Clear old markers
    competitorMarkers.forEach(m=>m.setMap(null));
    competitorMarkers = [];

    // Collect competitors
    const radiusMeters = miles * 1609.34;

    // Paginated: dentists + orthodontist keyword
    const dentist = await nearbyPaged({ location:center, radius: radiusMeters, type:'dentist' }, 60);
    const ortho   = await nearbyPaged({ location:center, radius: radiusMeters, type:'dentist', keyword:'orthodontist' }, 60);

    // Invisalign "presence" proxy via Text Search
    const invis   = await textSearchPaged({ location:center, radius: radiusMeters, query:'Invisalign dentist' }, 40);

    // Merge + dedupe by place_id (skip the selected practice)
    const byId = new Map();
    [...dentist, ...ortho].forEach(p=>{
      if(!p.place_id || p.place_id === place.place_id) return;
      byId.set(p.place_id, p);
    });
    const unique = [...byId.values()];

    // Counts
    const dentOnly = unique.filter(p => !(p.name||'').toLowerCase().includes('orthodont'));
    const orthoOnly = unique.filter(p => (p.name||'').toLowerCase().includes('orthodont'));
    const invisIds = new Set((invis || []).map(r => r.place_id).filter(Boolean));
    const invisCount = [...invisIds].filter(id => byId.has(id)).length;

    // Plot markers + bounds
    const bounds = new google.maps.LatLngBounds();
    bounds.extend(center);
    let nearest = {dist: Number.POSITIVE_INFINITY, name:null};

    unique.forEach(p=>{
      if(!p.geometry || !p.geometry.location) return;
      const loc = p.geometry.location;
      const d = google.maps.geometry.spherical.computeDistanceBetween(center, loc);
      if(d < nearest.dist){ nearest = { dist:d, name:p.name || 'Nearby Practice' }; }

      const isOrtho = (p.name||'').toLowerCase().includes('orthodont');
      const marker = new google.maps.Marker({
        position: loc, map, title: p.name,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          fillColor: isOrtho ? "#0c3141" : BRAND.teal,
          fillOpacity: .85,
          strokeColor: isOrtho ? "#071a23" : "#003e4f",
          strokeWeight: 2, scale: 6
        }
      });
      marker.addListener('click', ()=>openInfo(marker, p));

      competitorMarkers.push(marker);
      bounds.extend(loc);
    });

    map.fitBounds(bounds);

    // Stats UI
    $('dentistCount').textContent = dentOnly.length.toString();
    $('orthoCount').textContent   = orthoOnly.length.toString();
    $('totalCount').textContent   = unique.length.toString();
    $('invisCount').textContent   = invisCount.toString();

    // Density (competitors per square mile)
    const areaSqMi = Math.PI * miles * miles;
    const density  = unique.length / areaSqMi;
    const badge    = $('densityBadge');
    let cls='med', label='Balanced';
    if(density <= 0.7){ cls='low'; label='Openings present'; }
    else if(density >= 1.6){ cls='high'; label='Well-served'; }
    badge.className = `badge ${cls}`;
    badge.textContent = `Density — ${label} • ${density.toFixed(2)} / mi²`;

    if(nearest.name){
      const milesNearest = (nearest.dist/1609.34).toFixed(2);
      $('nearestMeta').textContent = `Nearest competitor: ${nearest.name} at ${milesNearest} mi`;
    }else{
      $('nearestMeta').textContent = '';
    }

    // AI payload
    try{
      const payload = {
        name: place.name || '',
        address: place.formatted_address || '',
        lat: centerLL.lat, lon: centerLL.lng,
        radius: miles,
        density: density.toFixed(2),
        competitor_info: {
          total: unique.length,
          dentists: dentOnly.length,
          orthodontists: orthoOnly.length,
          invisalign_mentions: invisCount,
          nearest: $('nearestMeta').textContent
        }
      };

      const res = await fetch('/api/generate-insight', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!res.ok){
        const t = await res.text();
        $('ai').textContent = `AI error: ${t}`;
      }else{
        const data = await res.json();
        $('ai').textContent = data.insight || 'No insight returned.';
      }
    }catch(err){
      $('ai').textContent = `AI request failed: ${err?.message || err}`;
    }finally{
      $('ai').classList.remove('loading');
    }
  }
  </script>
</body>
</html>
