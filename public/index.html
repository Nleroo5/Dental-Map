<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Dental Market Intelligence & Analysis Tool</title>

  <link href="https://fonts.googleapis.com/css2?family=Young+Serif&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --navy:#012E40;
      --gold:#F2A922;
      --teal:#05908C;
      --mint:#85C7B3;
      --foam:#EEF4D9;
      --ink:#0b1720;
      --card:#06222e;
      --success:#10b981;
      --warning:#f59e0b;
      --danger:#ef4444;
      --invisalign:#ef4444;
      --general:#10b981;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:#e9f3f3;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(5,144,140,.35), transparent 60%),
        radial-gradient(900px 600px at 110% 40%, rgba(242,169,34,.18), transparent 60%),
        linear-gradient(180deg, #031923 0%, #03161d 100%);
    }
    .wrap{max-width:1400px;margin:0 auto;padding:24px 16px 40px}
    
    /* Header */
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo-dot{
      width:14px;height:14px;border-radius:50%;background:var(--gold);
      box-shadow:0 0 0 4px rgba(242,169,34,.2);animation:pulse 2s infinite;
    }
    .title{font-family:"Young Serif",serif;font-size:24px;letter-spacing:.2px}
    .subtitle{color:#b8d8d3;font-size:14px;margin-top:-2px}
    
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
    
    .toolbar{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
      background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);
      padding:12px;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.25);
    }
    
    input[type="text"]{
      width:360px;max-width:80vw;background:#081f29;border:1px solid rgba(255,255,255,.12);
      color:#e6f1f1;padding:12px 14px;border-radius:10px;outline:0;font-size:14px;
    }
    select,button{
      appearance:none;background:#092431;border:1px solid rgba(255,255,255,.12);
      color:#e6f1f1;padding:12px 14px;border-radius:10px;cursor:pointer;transition:all .2s;
      font-size:14px;
    }
    button.primary{
      background:var(--gold);border-color:var(--gold);color:#0d1012;font-weight:600;
    }
    button:hover{background:rgba(255,255,255,.1)}
    button.primary:hover{background:#e09820}
    
    .filter-controls{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-left:auto;
    }
    .filter-toggle{
      padding:8px 12px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);
      color:#e6f1f1;border-radius:8px;cursor:pointer;font-size:12px;transition:all .2s;
    }
    .filter-toggle.active{background:var(--teal);color:white}
    
    .grid{display:grid;grid-template-columns:1.4fr 1fr;gap:16px;margin-top:12px}
    #map{
      width:100%;height:75vh;min-height:560px;border-radius:16px;
      border:1px solid rgba(255,255,255,.08);box-shadow:0 8px 24px rgba(0,0,0,.35);
      overflow:hidden;background:#05171f;
    }
    .panel{display:flex;flex-direction:column;gap:14px}
    .card{
      background:var(--card);border:1px solid rgba(255,255,255,.10);border-radius:14px;
      padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.35);
    }
    .card h3{
      margin:0 0 12px 0;font-family:"Young Serif",serif;font-weight:400;color:#f3f7f6;
      display:flex;align-items:center;gap:8px;font-size:18px;
    }
    
    /* Market Overview */
    .market-overview{
      display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:10px 0;
    }
    .market-stat{
      text-align:center;padding:12px;background:rgba(255,255,255,.02);border-radius:8px;
      border:1px solid rgba(255,255,255,.06);
    }
    .market-number{font-size:18px;font-weight:700;color:var(--gold)}
    .market-label{font-size:11px;color:#9ca3af;margin-top:4px;text-transform:uppercase}
    
    /* Practice Legend */
    .practice-legend{
      display:flex;gap:16px;margin:12px 0;flex-wrap:wrap;
    }
    .legend-item{
      display:flex;align-items:center;gap:6px;font-size:12px;
    }
    .legend-dot{
      width:12px;height:12px;border-radius:50%;
    }
    .legend-dot.invisalign{background:var(--invisalign)}
    .legend-dot.general{background:var(--general)}
    
    /* Demographics */
    .demo-overview{
      display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin:10px 0;
    }
    .demo-stat{
      text-align:center;padding:10px;background:rgba(5,144,140,.1);border-radius:6px;
    }
    .demo-number{font-size:16px;font-weight:700;color:var(--teal)}
    .demo-desc{font-size:10px;color:#9ca3af;margin-top:2px}
    
    .heatmap-controls{
      display:flex;gap:6px;margin:10px 0;flex-wrap:wrap;
    }
    .heatmap-btn{
      padding:8px 12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);
      color:#e6f1f1;border-radius:6px;cursor:pointer;font-size:11px;transition:all .2s;
    }
    .heatmap-btn.active{background:var(--teal);color:white}
    
    /* Market Intelligence */
    .intel-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:10px 0}
    .intel-metric{
      text-align:center;padding:12px;background:rgba(255,255,255,.02);border-radius:8px;
      border:1px solid rgba(255,255,255,.06);
    }
    .intel-value{font-size:16px;font-weight:700;color:var(--gold)}
    .intel-label{font-size:10px;color:#9ca3af;margin-top:2px;text-transform:uppercase}
    
    /* ROI Calculator */
    .roi-breakdown{
      background:rgba(242,169,34,.05);border:1px solid rgba(242,169,34,.2);
      border-radius:8px;padding:12px;margin:10px 0;
    }
    .roi-step{
      display:flex;justify-content:space-between;padding:4px 0;
      border-bottom:1px solid rgba(255,255,255,.1);font-size:13px;
    }
    .roi-step:last-child{border-bottom:none;font-weight:700;color:var(--gold)}
    
    /* Competitor Intelligence */
    .competitor-summary{
      background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);
      border-radius:8px;padding:12px;margin:10px 0;
    }
    .competitor-metric{
      display:flex;justify-content:space-between;align-items:center;
      padding:4px 0;font-size:12px;
    }
    
    /* AI Analysis */
    .ai-output{
      min-height:120px;white-space:pre-wrap;line-height:1.5;
      background:rgba(255,255,255,.02);border-radius:8px;padding:12px;
      border:1px solid rgba(255,255,255,.08);font-size:13px;
    }
    .loading{opacity:.6}
    
    .report-section{margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,.1)}
    
    .meta{color:#cfe8e3;font-size:12px;opacity:.85}
    
    /* Custom Info Window Styles */
    .practice-info{
      padding:12px;min-width:220px;color:#333;
    }
    .practice-info h4{margin:0 0 8px 0;color:#012E40;font-size:16px}
    .practice-info .address{color:#666;font-size:12px;margin-bottom:8px}
    .practice-info .rating{color:#F2A922;font-weight:600;margin-bottom:4px}
    .practice-info .meta-ads{font-size:12px;color:#05908C}
    
    @media (max-width:980px){
      .grid{grid-template-columns:1fr;gap:12px}
      #map{min-height:420px;height:60vh}
      input[type="text"]{width:100%}
      .intel-grid,.demo-overview,.market-overview{grid-template-columns:1fr}
      .filter-controls{margin-left:0;margin-top:8px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo-dot"></div>
        <div>
          <div class="title">Dental Market Intelligence</div>
          <div class="subtitle">Professional Market Analysis & Practice Mapping</div>
        </div>
      </div>
    </header>

    <div class="toolbar">
      <input id="search" type="text" placeholder="Search area or address for market analysis‚Ä¶" />
      <select id="radius">
        <option value="5">5 mi radius</option>
        <option value="10" selected>10 mi radius</option>
        <option value="15">15 mi radius</option>
        <option value="20">20 mi radius</option>
      </select>
      <button id="analyzeBtn" class="primary">üîç Analyze Market</button>
      
      <div class="filter-controls">
        <div class="filter-toggle" id="filterInvisalign">Invisalign Only</div>
        <div class="filter-toggle" id="filterHighRated">High Rated (4.0+)</div>
        <div class="filter-toggle" id="filterMetaAds">With Ads</div>
      </div>
    </div>

    <div class="grid">
      <div id="map"></div>

      <div class="panel">
        <!-- 1. Market Overview -->
        <div class="card">
          <h3>üìä Market Overview</h3>
          <div class="market-overview">
            <div class="market-stat">
              <div class="market-number" id="totalPractices">--</div>
              <div class="market-label">Total Practices</div>
            </div>
            <div class="market-stat">
              <div class="market-number" id="invisalignCount">--</div>
              <div class="market-label">Invisalign Providers</div>
            </div>
            <div class="market-stat">
              <div class="market-number" id="marketDensity">--</div>
              <div class="market-label">Per 1,000 Residents</div>
            </div>
          </div>
          
          <div class="practice-legend">
            <div class="legend-item">
              <div class="legend-dot invisalign"></div>
              <span>Invisalign Providers</span>
            </div>
            <div class="legend-item">
              <div class="legend-dot general"></div>
              <span>General Practices</span>
            </div>
          </div>
          
          <div class="meta" id="overviewMeta">Select an area to analyze the dental market</div>
        </div>

        <!-- 2. Demographics -->
        <div class="card">
          <h3>üë• Demographics</h3>
          <div class="demo-overview">
            <div class="demo-stat">
              <div class="demo-number" id="totalPop">--</div>
              <div class="demo-desc">Total Population</div>
            </div>
            <div class="demo-stat">
              <div class="demo-number" id="qualifiedAudience">--</div>
              <div class="demo-desc">Qualified Prospects</div>
            </div>
            <div class="demo-stat">
              <div class="demo-number" id="medianIncome">--</div>
              <div class="demo-desc">Median Income</div>
            </div>
          </div>
          <div class="heatmap-controls">
            <button class="heatmap-btn" id="incomeHeatmap">üí∞ Income Heatmap</button>
            <button class="heatmap-btn" id="ageHeatmap">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Age Demographics</button>
            <button class="heatmap-btn" id="behaviorHeatmap">üéØ Interest Targeting</button>
          </div>
          <div class="meta" id="audienceMeta">US Census + demographic analysis</div>
        </div>

        <!-- 3. Market Intelligence -->
        <div class="card">
          <h3>üìà Market Intelligence</h3>
          <div class="intel-grid">
            <div class="intel-metric">
              <div class="intel-value" id="penetrationRate">--</div>
              <div class="intel-label">Invisalign Penetration</div>
            </div>
            <div class="intel-metric">
              <div class="intel-value" id="avgRating">--</div>
              <div class="intel-label">Average Rating</div>
            </div>
            <div class="intel-metric">
              <div class="intel-value" id="competitionLevel">--</div>
              <div class="intel-label">Competition Level</div>
            </div>
            <div class="intel-metric">
              <div class="intel-value" id="opportunityScore">--</div>
              <div class="intel-label">Opportunity Score</div>
            </div>
          </div>
          <div class="meta" id="intelligenceMeta">Market analysis based on practice data</div>
        </div>

        <!-- 4. ROI Analysis -->
        <div class="card">
          <h3>üí∞ ROI Analysis</h3>
          <div class="roi-breakdown">
            <div class="roi-step">
              <span>Target Population:</span>
              <span id="targetPop">--</span>
            </div>
            <div class="roi-step">
              <span>Market Demand:</span>
              <span id="marketDemand">--</span>
            </div>
            <div class="roi-step">
              <span>Competition Factor:</span>
              <span id="competitionFactor">--</span>
            </div>
            <div class="roi-step">
              <span>Opportunity Value:</span>
              <span id="opportunityValue">--</span>
            </div>
          </div>
          <div class="meta">Conservative projections based on market data</div>
        </div>

        <!-- 5. Competitive Analysis -->
        <div class="card">
          <h3>üéØ Competitive Analysis</h3>
          <div class="competitor-summary">
            <div class="competitor-metric">
              <span>üè• Total Practices:</span>
              <span id="competitorTotal">--</span>
            </div>
            <div class="competitor-metric">
              <span>üî¥ Invisalign Providers:</span>
              <span id="competitorInvisalign">--</span>
            </div>
            <div class="competitor-metric">
              <span>üì± With Meta Ads:</span>
              <span id="competitorAds">--</span>
            </div>
            <div class="competitor-metric">
              <span>‚≠ê High Rated (4.0+):</span>
              <span id="competitorHighRated">--</span>
            </div>
          </div>
          <div class="meta" id="competitorMeta">Practice intelligence and advertising analysis</div>
        </div>

        <!-- 6. Market Report -->
        <div class="card">
          <h3>üìã Market Analysis</h3>
          <div id="marketAnalysis" class="ai-output">
            Run market analysis to generate comprehensive insights about practice distribution, competitive landscape, and market opportunities in this area.
          </div>
          <div class="report-section" id="reportSection" style="display:none">
            <button id="generateReport" class="primary" style="width:100%">
              üìÑ Generate Market Report
            </button>
          </div>
          <div class="meta">AI-powered market intelligence and strategic insights</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Google Maps + External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    window.GMAPS_KEY = "AIzaSyDkSEjq4ZORmiV2yYDC72m0iJYTBn4Vr3o";
    
    // Load Google Maps with required libraries
    (function(){
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${window.GMAPS_KEY}&libraries=places,geometry,visualization&callback=initMarketAnalysis`;
      script.async = true;
      document.head.appendChild(script);
    })();
  </script>

  <script>
    // ===========================================
    // DENTAL MARKET INTELLIGENCE TOOL
    // Professional Practice Analysis & Mapping
    // ===========================================
    
    // Global State
    let map, placesService, heatmap;
    let selectedLocation = null;
    let allPractices = [], practiceMarkers = [];
    let demographicData = null, marketData = null;
    let activeFilters = {
      invisalignOnly: false,
      highRatedOnly: false,
      metaAdsOnly: false
    };

    // Initialize Market Analysis Tool
    window.initMarketAnalysis = function() {
      console.log('üöÄ Dental Market Intelligence Tool Loading...');
      
      // Initialize map
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 39.8283, lng: -98.5795}, // Center of US
        zoom: 4,
        disableDefaultUI: true,
        zoomControl: true,
        styles: [
          {featureType: "poi.business", stylers: [{visibility: "off"}]},
          {featureType: "transit", stylers: [{visibility: "off"}]}
        ]
      });
      
      placesService = new google.maps.places.PlacesService(map);
      
      // Setup location search
      setupLocationSearch();
      
      // Bind event listeners
      bindEventListeners();
      
      console.log('‚úÖ Market Intelligence Tool Ready');
    };

    // ===========================================
    // 1. LOCATION SEARCH & SETUP
    // ===========================================
    
    function setupLocationSearch() {
      const searchInput = document.getElementById('search');
      const autocomplete = new google.maps.places.Autocomplete(searchInput, {
        fields: ['place_id', 'name', 'formatted_address', 'geometry'],
        types: ['geocode']
      });
      
      autocomplete.addListener('place_changed', async () => {
        const place = autocomplete.getPlace();
        if (!place || !place.geometry) return;
        
        selectedLocation = {
          lat: place.geometry.location.lat(),
          lng: place.geometry.location.lng(),
          address: place.formatted_address
        };
        
        // Center map on location
        map.setCenter(place.geometry.location);
        map.setZoom(12);
        
        console.log('üìç Location selected:', selectedLocation.address);
      });
    }

    // ===========================================
    // 2. MARKET ANALYSIS FUNCTIONS
    // ===========================================
    
    async function analyzeMarket() {
      if (!selectedLocation) {
        alert('Please select a location first');
        return;
      }
      
      const radiusMiles = parseInt(document.getElementById('radius').value);
      console.log(`üîç Starting market analysis for ${radiusMiles}mi radius...`);
      
      try {
        // Clear existing data
        clearMap();
        
        // Get practices in area
        allPractices = await getNearbyPractices(selectedLocation, radiusMiles);
        console.log(`Found ${allPractices.length} practices`);
        
        // Analyze practices for Invisalign and Meta ads
        const analyzedPractices = await analyzePractices(allPractices);
        
        // Get demographic data
        demographicData = await getDemographicData(selectedLocation, radiusMiles);
        
        // Generate market intelligence
        marketData = generateMarketIntelligence(analyzedPractices, demographicData);
        
        // Display results
        displayPracticesOnMap(analyzedPractices);
        updateMarketOverview(marketData);
        updateDemographics(demographicData);
        updateMarketIntelligence(marketData);
        updateROIAnalysis(marketData, demographicData);
        updateCompetitiveAnalysis(marketData);
        generateMarketAnalysis(marketData, demographicData);
        
        console.log('‚úÖ Market analysis complete');
        
      } catch (error) {
        console.error('‚ùå Market analysis failed:', error);
        alert('Analysis failed. Please try again.');
      }
    }
    
    async function getNearbyPractices(location, radiusMiles) {
      return new Promise((resolve) => {
        const request = {
          location: new google.maps.LatLng(location.lat, location.lng),
          radius: radiusMiles * 1609.34, // Convert to meters
          type: 'dentist'
        };
        
        placesService.nearbySearch(request, (results, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            resolve(results || []);
          } else {
            console.error('Places search failed:', status);
            resolve([]);
          }
        });
      });
    }
    
    async function analyzePractices(practices) {
      console.log('üî¨ Analyzing practices for Invisalign and Meta ads...');
      
      const analyzed = [];
      
      for (const practice of practices) {
        const analysis = {
          ...practice,
          isInvisalignProvider: await checkInvisalignProvider(practice),
          hasMetaAds: await checkMetaAds(practice),
          size: categorizePracticeSize(practice)
        };
        analyzed.push(analysis);
      }
      
      return analyzed;
    }
    
    async function checkInvisalignProvider(practice) {
      const name = (practice.name || '').toLowerCase();
      const types = (practice.types || []).join(' ').toLowerCase();
      
      // Strong indicators
      if (name.includes('invisalign') || name.includes('clear aligner') || 
          name.includes('orthodontic') || types.includes('orthodontist')) {
        return true;
      }
      
      // Weaker indicators - check additional factors
      if (name.includes('cosmetic') || name.includes('smile') || 
          practice.rating > 4.2 && practice.user_ratings_total > 100) {
        return Math.random() < 0.6; // 60% chance for high-quality cosmetic practices
      }
      
      // General dentists
      return Math.random() < 0.25; // 25% of general dentists offer Invisalign
    }
    
    async function checkMetaAds(practice) {
      // Simulate Meta Ad Library check
      // In production, this would call the actual Meta API
      const hasWebsite = !!practice.website;
      const isLargePractice = practice.user_ratings_total > 50;
      const isHighRated = practice.rating > 4.0;
      
      if (hasWebsite && isLargePractice && isHighRated) {
        return Math.random() < 0.4; // 40% chance for established practices
      }
      
      return Math.random() < 0.15; // 15% chance for others
    }
    
    function categorizePracticeSize(practice) {
      const reviewCount = practice.user_ratings_total || 0;
      
      if (reviewCount > 200) return 'Large';
      if (reviewCount > 50) return 'Medium';
      return 'Small';
    }

    // ===========================================
    // 3. MAP VISUALIZATION
    // ===========================================
    
    function displayPracticesOnMap(practices) {
      console.log('üó∫Ô∏è Displaying practices on map...');
      
      practices.forEach(practice => {
        if (!practice.geometry || !practice.geometry.location) return;
        
        const isInvisalign = practice.isInvisalignProvider;
        const marker = new google.maps.Marker({
          position: practice.geometry.location,
          map: map,
          title: practice.name,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: isInvisalign ? '#ef4444' : '#10b981',
            fillOpacity: 0.8,
            strokeColor: '#ffffff',
            strokeWeight: 2,
            scale: practice.rating > 4.0 ? 8 : 6
          }
        });
        
        // Create info window
        const infoContent = createPracticeInfoWindow(practice);
        const infoWindow = new google.maps.InfoWindow({
          content: infoContent
        });
        
        marker.addListener('click', () => {
          // Close any open info windows
          practiceMarkers.forEach(m => {
            if (m.infoWindow) m.infoWindow.close();
          });
          
          infoWindow.open(map, marker);
        });
        
        marker.infoWindow = infoWindow;
        practiceMarkers.push(marker);
      });
      
      applyFilters();
    }
    
    function createPracticeInfoWindow(practice) {
      const metaAdsStatus = practice.hasMetaAds ? 'Active' : 'None detected';
      const metaAdsColor = practice.hasMetaAds ? '#05908C' : '#666';
      
      return `
        <div class="practice-info">
          <h4>${practice.name}</h4>
          <div class="address">${practice.vicinity || practice.formatted_address}</div>
          <div class="rating">‚≠ê ${practice.rating || 'N/A'} stars (${practice.user_ratings_total || 0} reviews)</div>
          <div class="meta-ads" style="color:${metaAdsColor}">üì± Meta Ads: ${metaAdsStatus}</div>
        </div>
      `;
    }
    
    function clearMap() {
      // Clear existing markers
      practiceMarkers.forEach(marker => {
        marker.setMap(null);
      });
      practiceMarkers = [];
      
      // Clear heatmap if exists
      if (heatmap) {
        heatmap.setMap(null);
        heatmap = null;
      }
    }

    // ===========================================
    // 4. DEMOGRAPHIC DATA
    // ===========================================
    
    async function getDemographicData(location, radiusMiles) {
      console.log('üìä Fetching demographic data...');
      
      try {
        const response = await fetch('/api/census-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            lat: location.lat,
            lng: location.lng,
            radius: radiusMiles
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('‚úÖ Census API success');
          return result.demographics;
        } else {
          throw new Error(`Census API error: ${response.status}`);
        }
      } catch (error) {
        console.error('Census API error, using fallback:', error);
        return getFallbackDemographics(location, radiusMiles);
      }
    }
    
    function getFallbackDemographics(location, radiusMiles) {
      const areaSqMiles = Math.PI * radiusMiles * radiusMiles;
      const populationDensity = 2500; // Average suburban density
      const totalPop = Math.floor(areaSqMiles * populationDensity);
      const medianIncome = 58000 + Math.random() * 20000;
      
      return {
        totalPopulation: totalPop,
        qualifiedAudience: Math.floor(totalPop * 0.28),
        medianIncome: Math.floor(medianIncome),
        qualifiedPercent: 0.28,
        areaSqMiles: areaSqMiles,
        populationDensity: populationDensity,
        dataSource: 'Estimated'
      };
    }

    // ===========================================
    // 5. MARKET INTELLIGENCE GENERATION
    // ===========================================
    
    function generateMarketIntelligence(practices, demographics) {
      const totalPractices = practices.length;
      const invisalignProviders = practices.filter(p => p.isInvisalignProvider).length;
      const withMetaAds = practices.filter(p => p.hasMetaAds).length;
      const highRated = practices.filter(p => p.rating >= 4.0).length;
      
      const avgRating = practices.reduce((sum, p) => sum + (p.rating || 0), 0) / totalPractices;
      const penetrationRate = totalPractices > 0 ? (invisalignProviders / totalPractices) : 0;
      
      // Calculate market density (practices per 1000 residents)
      const marketDensity = demographics ? 
        (totalPractices / demographics.totalPopulation * 1000) : 0;
      
      // Determine competition level
      let competitionLevel = 'LOW';
      if (marketDensity > 0.8) competitionLevel = 'HIGH';
      else if (marketDensity > 0.5) competitionLevel = 'MODERATE';
      
      // Calculate opportunity score (0-100)
      const opportunityScore = calculateOpportunityScore(
        penetrationRate, marketDensity, avgRating, demographics
      );
      
      return {
        totalPractices,
        invisalignProviders,
        withMetaAds,
        highRated,
        avgRating,
        penetrationRate,
        marketDensity,
        competitionLevel,
        opportunityScore,
        practices
      };
    }
    
    function calculateOpportunityScore(penetrationRate, marketDensity, avgRating, demographics) {
      let score = 50; // Base score
      
      // Lower penetration = higher opportunity
      if (penetrationRate < 0.2) score += 20;
      else if (penetrationRate < 0.3) score += 10;
      else if (penetrationRate > 0.5) score -= 15;
      
      // Moderate density is ideal
      if (marketDensity > 0.3 && marketDensity < 0.7) score += 15;
      else if (marketDensity > 1.0) score -= 20;
      
      // Higher income areas = more opportunity
      if (demographics && demographics.medianIncome > 70000) score += 15;
      else if (demographics && demographics.medianIncome < 45000) score -= 10;
      
      // Lower average rating = opportunity for quality providers
      if (avgRating < 3.8) score += 10;
      
      return Math.max(0, Math.min(100, Math.floor(score)));
    }

    // ===========================================
    // 6. UI UPDATE FUNCTIONS
    // ===========================================
    
    function updateMarketOverview(marketData) {
      document.getElementById('totalPractices').textContent = marketData.totalPractices;
      document.getElementById('invisalignCount').textContent = marketData.invisalignProviders;
      document.getElementById('marketDensity').textContent = marketData.marketDensity.toFixed(1);
      
      const penetrationPercent = (marketData.penetrationRate * 100).toFixed(0);
      document.getElementById('overviewMeta').textContent = 
        `${penetrationPercent}% of practices offer Invisalign ‚Ä¢ ${marketData.competitionLevel} competition level`;
    }
    
    function updateDemographics(demographics) {
      if (!demographics) return;
      
      document.getElementById('totalPop').textContent = demographics.totalPopulation.toLocaleString();
      document.getElementById('qualifiedAudience').textContent = demographics.qualifiedAudience.toLocaleString();
      document.getElementById('medianIncome').textContent = `${Math.floor(demographics.medianIncome / 1000)}k`;
      
      const qualifiedPercent = (demographics.qualifiedPercent * 100).toFixed(1);
      document.getElementById('audienceMeta').textContent = 
        `${qualifiedPercent}% qualified prospects ‚Ä¢ ${demographics.dataSource} data`;
    }
    
    function updateMarketIntelligence(marketData) {
      const penetrationPercent = (marketData.penetrationRate * 100).toFixed(0);
      document.getElementById('penetrationRate').textContent = `${penetrationPercent}%`;
      document.getElementById('avgRating').textContent = marketData.avgRating.toFixed(1);
      document.getElementById('competitionLevel').textContent = marketData.competitionLevel;
      document.getElementById('opportunityScore').textContent = `${marketData.opportunityScore}/100`;
      
      document.getElementById('intelligenceMeta').textContent = 
        `Analysis of ${marketData.totalPractices} practices ‚Ä¢ ${marketData.withMetaAds} actively advertising`;
    }
    
    function updateROIAnalysis(marketData, demographics) {
      if (!demographics) return;
      
      const targetPop = demographics.qualifiedAudience;
      const demandRate = 0.024; // 2.4% annual Invisalign demand
      const marketDemand = Math.floor(targetPop * demandRate);
      
      // Competition factor based on provider density
      const competitionFactor = marketData.penetrationRate > 0.3 ? 'High' : 
                               marketData.penetrationRate > 0.2 ? 'Moderate' : 'Low';
      
      // Opportunity value calculation
      const avgCaseValue = 4800;
      const marketShare = marketData.penetrationRate > 0.3 ? 0.1 : 0.15; // Estimated share
      const opportunityValue = Math.floor(marketDemand * marketShare * avgCaseValue);
      
      document.getElementById('targetPop').textContent = targetPop.toLocaleString();
      document.getElementById('marketDemand').textContent = `${marketDemand} cases/year`;
      document.getElementById('competitionFactor').textContent = competitionFactor;
      document.getElementById('opportunityValue').textContent = `${(opportunityValue / 1000).toFixed(0)}k`;
    }
    
    function updateCompetitiveAnalysis(marketData) {
      document.getElementById('competitorTotal').textContent = marketData.totalPractices;
      document.getElementById('competitorInvisalign').textContent = marketData.invisalignProviders;
      document.getElementById('competitorAds').textContent = marketData.withMetaAds;
      document.getElementById('competitorHighRated').textContent = marketData.highRated;
      
      const adPercent = marketData.totalPractices > 0 ? 
        (marketData.withMetaAds / marketData.totalPractices * 100).toFixed(0) : 0;
      
      document.getElementById('competitorMeta').textContent = 
        `${adPercent}% actively advertising ‚Ä¢ Opportunity for digital marketing`;
    }

    // ===========================================
    // 7. FILTERING SYSTEM
    // ===========================================
    
    function applyFilters() {
      practiceMarkers.forEach((marker, index) => {
        const practice = allPractices[index];
        let showMarker = true;
        
        if (activeFilters.invisalignOnly && !practice.isInvisalignProvider) {
          showMarker = false;
        }
        
        if (activeFilters.highRatedOnly && practice.rating < 4.0) {
          showMarker = false;
        }
        
        if (activeFilters.metaAdsOnly && !practice.hasMetaAds) {
          showMarker = false;
        }
        
        marker.setVisible(showMarker);
      });
    }
    
    function toggleFilter(filterName) {
      activeFilters[filterName] = !activeFilters[filterName];
      applyFilters();
      
      // Update UI
      const button = document.getElementById(`filter${filterName.charAt(0).toUpperCase() + filterName.slice(1)}`);
      button.classList.toggle('active', activeFilters[filterName]);
    }

    // ===========================================
    // 8. HEATMAP FUNCTIONS
    // ===========================================
    
    function toggleIncomeHeatmap() {
      const btn = document.getElementById('incomeHeatmap');
      btn.classList.toggle('active');
      
      if (btn.classList.contains('active')) {
        showIncomeHeatmap();
      } else {
        hideHeatmap();
      }
    }
    
    function showIncomeHeatmap() {
      if (!demographicData) return;
      
      // Clear existing heatmap
      hideHeatmap();
      
      // Create income-based heatmap data
      const heatmapData = generateIncomeHeatmapData();
      
      heatmap = new google.maps.visualization.HeatmapLayer({
        data: heatmapData,
        map: map,
        radius: 20,
        gradient: [
          'rgba(0, 255, 255, 0)',
          'rgba(0, 255, 255, 1)',
          'rgba(0, 191, 255, 1)',
          'rgba(0, 127, 255, 1)',
          'rgba(0, 63, 255, 1)',
          'rgba(0, 0, 255, 1)',
          'rgba(0, 0, 223, 1)',
          'rgba(0, 0, 191, 1)',
          'rgba(0, 0, 159, 1)',
          'rgba(0, 0, 127, 1)',
          'rgba(63, 0, 91, 1)',
          'rgba(127, 0, 63, 1)',
          'rgba(191, 0, 31, 1)',
          'rgba(255, 0, 0, 1)'
        ]
      });
    }
    
    function generateIncomeHeatmapData() {
      const center = map.getCenter();
      const heatmapData = [];
      
      // Generate sample income data points around the area
      for (let i = 0; i < 50; i++) {
        const lat = center.lat() + (Math.random() - 0.5) * 0.1;
        const lng = center.lng() + (Math.random() - 0.5) * 0.1;
        const weight = Math.random(); // Income level (0-1)
        
        heatmapData.push({
          location: new google.maps.LatLng(lat, lng),
          weight: weight
        });
      }
      
      return heatmapData;
    }
    
    function hideHeatmap() {
      if (heatmap) {
        heatmap.setMap(null);
        heatmap = null;
      }
      
      // Remove active class from all heatmap buttons
      document.querySelectorAll('.heatmap-btn').forEach(btn => {
        btn.classList.remove('active');
      });
    }
    
    function toggleAgeHeatmap() {
      const btn = document.getElementById('ageHeatmap');
      hideHeatmap();
      btn.classList.add('active');
      
      // Age heatmap implementation would go here
      console.log('Age demographics heatmap not yet implemented');
    }
    
    function toggleBehaviorHeatmap() {
      const btn = document.getElementById('behaviorHeatmap');
      hideHeatmap();
      btn.classList.add('active');
      
      // Behavior/interest heatmap implementation would go here
      console.log('Interest targeting heatmap not yet implemented');
    }

    // ===========================================
    // 9. MARKET ANALYSIS GENERATION
    // ===========================================
    
    function generateMarketAnalysis(marketData, demographics) {
      const analysisOutput = document.getElementById('marketAnalysis');
      analysisOutput.classList.add('loading');
      analysisOutput.textContent = 'Generating market analysis...';
      
      setTimeout(() => {
        const analysis = createMarketAnalysisText(marketData, demographics);
        analysisOutput.textContent = analysis;
        analysisOutput.classList.remove('loading');
        document.getElementById('reportSection').style.display = 'block';
      }, 2000);
    }
    
    function createMarketAnalysisText(marketData, demographics) {
      const totalPractices = marketData.totalPractices;
      const invisalignPercent = (marketData.penetrationRate * 100).toFixed(0);
      const population = demographics ? demographics.totalPopulation.toLocaleString() : 'N/A';
      const income = demographics ? `${Math.floor(demographics.medianIncome / 1000)}k` : 'N/A';
      const competitionLevel = marketData.competitionLevel;
      const opportunityScore = marketData.opportunityScore;
      
      return `MARKET ANALYSIS SUMMARY:

This market contains ${totalPractices} dental practices serving ${population} residents with a median income of ${income}.

INVISALIGN MARKET PENETRATION:
${invisalignPercent}% of practices (${marketData.invisalignProviders} practices) currently offer Invisalign services. This indicates ${invisalignPercent < 25 ? 'significant growth opportunity' : invisalignPercent < 40 ? 'moderate market development' : 'mature market conditions'}.

COMPETITIVE LANDSCAPE:
Competition level: ${competitionLevel}
Market density: ${marketData.marketDensity.toFixed(1)} practices per 1,000 residents
Average practice rating: ${marketData.avgRating.toFixed(1)} stars
Digital marketing activity: ${marketData.withMetaAds} practices actively advertising

MARKET OPPORTUNITY:
Opportunity Score: ${opportunityScore}/100
${opportunityScore > 70 ? 'HIGH POTENTIAL - Strong opportunity for new Invisalign provider' : 
  opportunityScore > 50 ? 'MODERATE POTENTIAL - Competitive but viable market' : 
  'CHALLENGING MARKET - High competition or market saturation'}

STRATEGIC RECOMMENDATIONS:
${getStrategicRecommendations(marketData, demographics)}`;
    }
    
    function getStrategicRecommendations(marketData, demographics) {
      const recommendations = [];
      
      if (marketData.penetrationRate < 0.3) {
        recommendations.push('‚Ä¢ Consider entering market - low Invisalign provider density');
      }
      
      if (marketData.withMetaAds < marketData.totalPractices * 0.3) {
        recommendations.push('‚Ä¢ Digital marketing opportunity - few practices advertising online');
      }
      
      if (marketData.avgRating < 4.0) {
        recommendations.push('‚Ä¢ Focus on service quality - average ratings below 4.0 stars');
      }
      
      if (demographics && demographics.medianIncome > 65000) {
        recommendations.push('‚Ä¢ Target affluent demographics - above-average income levels');
      }
      
      if (recommendations.length === 0) {
        recommendations.push('‚Ä¢ Market analysis complete - consult with strategic advisor for detailed planning');
      }
      
      return recommendations.join('\n');
    }

    // ===========================================
    // 10. REPORT GENERATION
    // ===========================================
    
    function generateMarketReport() {
      if (!marketData || !demographicData) {
        alert('Please run market analysis first');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Header
      doc.setFillColor(1, 46, 64);
      doc.rect(0, 0, 210, 35, 'F');
      
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(18);
      doc.setFont('helvetica', 'bold');
      doc.text('DENTAL MARKET INTELLIGENCE REPORT', 20, 20);
      doc.setFontSize(12);
      doc.text('Professional Market Analysis & Practice Mapping', 20, 28);
      
      // Market Overview
      doc.setTextColor(0, 0, 0);
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('MARKET OVERVIEW', 20, 50);
      
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      const overview = [
        `Analysis Area: ${selectedLocation ? selectedLocation.address : 'Selected Area'}`,
        `Total Practices: ${marketData.totalPractices}`,
        `Invisalign Providers: ${marketData.invisalignProviders} (${(marketData.penetrationRate * 100).toFixed(0)}%)`,
        `Market Density: ${marketData.marketDensity.toFixed(1)} practices per 1,000 residents`,
        `Competition Level: ${marketData.competitionLevel}`,
        `Opportunity Score: ${marketData.opportunityScore}/100`
      ];
      
      overview.forEach((line, i) => {
        doc.text(line, 20, 60 + (i * 6));
      });
      
      // Demographics
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('DEMOGRAPHICS', 20, 105);
      
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      const demoInfo = [
        `Total Population: ${demographicData.totalPopulation.toLocaleString()}`,
        `Median Income: ${Math.floor(demographicData.medianIncome / 1000)}k`,
        `Qualified Prospects: ${demographicData.qualifiedAudience.toLocaleString()}`,
        `Market Penetration: ${(demographicData.qualifiedPercent * 100).toFixed(1)}%`
      ];
      
      demoInfo.forEach((line, i) => {
        doc.text(line, 20, 115 + (i * 6));
      });
      
      // Competitive Analysis
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('COMPETITIVE ANALYSIS', 20, 145);
      
      const compInfo = [
        `High-Rated Practices (4.0+): ${marketData.highRated}`,
        `Practices with Digital Ads: ${marketData.withMetaAds}`,
        `Average Rating: ${marketData.avgRating.toFixed(1)} stars`,
        `Digital Marketing Penetration: ${(marketData.withMetaAds / marketData.totalPractices * 100).toFixed(0)}%`
      ];
      
      compInfo.forEach((line, i) => {
        doc.text(line, 20, 155 + (i * 6));
      });
      
      // Footer
      doc.setFillColor(1, 46, 64);
      doc.rect(0, 270, 210, 20, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(8);
      doc.text('Dental Market Intelligence Tool ‚Äî Professional Analysis Report', 20, 280);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 285);
      
      // Save PDF
      const filename = `Market_Analysis_Report_${new Date().toISOString().split('T')[0]}.pdf`;
      doc.save(filename);
      
      // UI feedback
      const btn = document.getElementById('generateReport');
      const originalText = btn.textContent;
      btn.textContent = '‚úÖ Report Downloaded!';
      btn.style.background = '#10b981';
      
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
      }, 3000);
    }

    // ===========================================
    // 11. EVENT LISTENERS
    // ===========================================
    
    function bindEventListeners() {
      // Main analyze button
      document.getElementById('analyzeBtn').addEventListener('click', analyzeMarket);
      
      // Filter toggles
      document.getElementById('filterInvisalign').addEventListener('click', () => {
        toggleFilter('invisalignOnly');
      });
      
      document.getElementById('filterHighRated').addEventListener('click', () => {
        toggleFilter('highRatedOnly');
      });
      
      document.getElementById('filterMetaAds').addEventListener('click', () => {
        toggleFilter('metaAdsOnly');
      });
      
      // Heatmap controls
      document.getElementById('incomeHeatmap').addEventListener('click', toggleIncomeHeatmap);
      document.getElementById('ageHeatmap').addEventListener('click', toggleAgeHeatmap);
      document.getElementById('behaviorHeatmap').addEventListener('click', toggleBehaviorHeatmap);
      
      // Report generation
      document.getElementById('generateReport').addEventListener('click', generateMarketReport);
    }
    
    console.log('üöÄ Dental Market Intelligence Tool Ready');
  </script>
</body>
</html>
