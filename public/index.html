<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Established Shot Territory Intelligence & ROI Engine‚Ñ¢</title>

  <link href="https://fonts.googleapis.com/css2?family=Young+Serif&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --navy:#012E40;
      --gold:#F2A922;
      --teal:#05908C;
      --mint:#85C7B3;
      --foam:#EEF4D9;
      --ink:#0b1720;
      --card:#06222e;
      --success:#10b981;
      --warning:#f59e0b;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:#e9f3f3;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(5,144,140,.35), transparent 60%),
        radial-gradient(900px 600px at 110% 40%, rgba(242,169,34,.18), transparent 60%),
        linear-gradient(180deg, #031923 0%, #03161d 100%);
    }
    .wrap{max-width:1400px;margin:0 auto;padding:24px 16px 40px}
    
    /* Header with scarcity messaging */
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo-dot{
      width:14px;height:14px;border-radius:50%;background:var(--gold);
      box-shadow:0 0 0 4px rgba(242,169,34,.2);animation:pulse 2s infinite;
    }
    .title{font-family:"Young Serif",serif;font-size:22px;letter-spacing:.2px}
    .subtitle{color:#b8d8d3;font-size:13px;margin-top:-2px}
    
    .scarcity-alert{
      display:flex;align-items:center;gap:8px;
      background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);
      padding:8px 12px;border-radius:8px;color:#fca5a5;font-weight:600;font-size:13px;
      animation:urgentPulse 3s infinite;
    }
    @keyframes urgentPulse{0%,100%{background:rgba(239,68,68,.15)}50%{background:rgba(239,68,68,.25)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
    
    .toolbar{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
      background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);
      padding:10px;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.25);
    }
    
    input[type="text"]{
      width:360px;max-width:80vw;background:#081f29;border:1px solid rgba(255,255,255,.12);
      color:#e6f1f1;padding:10px 12px;border-radius:10px;outline:0;
    }
    select,button{
      appearance:none;background:#092431;border:1px solid rgba(255,255,255,.12);
      color:#e6f1f1;padding:10px 12px;border-radius:10px;cursor:pointer;transition:all .2s;
    }
    button.primary{
      background:var(--gold);border-color:var(--gold);color:#0d1012;font-weight:700;
    }
    button.lock-territory{
      background:linear-gradient(135deg,var(--success),#059669);
      border-color:var(--success);color:white;font-weight:700;
      animation:lockPulse 2s infinite;box-shadow:0 0 20px rgba(16,185,129,.3);
    }
    @keyframes lockPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
    
    button.locked{
      background:#374151;border-color:#4b5563;color:#9ca3af;cursor:not-allowed;
    }
    
    .grid{display:grid;grid-template-columns:1.4fr 1fr;gap:14px;margin-top:10px}
    #map{
      width:100%;height:75vh;min-height:560px;border-radius:16px;
      border:1px solid rgba(255,255,255,.08);box-shadow:0 8px 24px rgba(0,0,0,.35);
      overflow:hidden;background:#05171f;
    }
    .panel{display:flex;flex-direction:column;gap:12px}
    .card{
      background:var(--card);border:1px solid rgba(255,255,255,.10);border-radius:14px;
      padding:14px 14px;box-shadow:0 10px 24px rgba(0,0,0,.35);
    }
    .card h3{
      margin:0 0 8px 0;font-family:"Young Serif",serif;font-weight:400;color:#f3f7f6;
      display:flex;align-items:center;gap:8px;
    }
    
    /* Territory Status with Psychological Triggers */
    .territory-status{
      padding:12px;border-radius:10px;margin-bottom:12px;
      background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);
    }
    .territory-status.locked{
      background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.2);
    }
    .territory-status.competitor-blocked{
      background:rgba(245,158,11,.08);border-color:rgba(245,158,11,.2);
    }
    .territory-status.hold{
      background:rgba(59,130,246,.08);border-color:rgba(59,130,246,.2);
    }
    
    .status-dot{width:8px;height:8px;border-radius:50%;margin-right:8px;display:inline-block}
    .status-dot.available{background:var(--success);animation:pulse 2s infinite}
    .status-dot.locked{background:var(--danger)}
    .status-dot.blocked{background:var(--warning)}
    .status-dot.hold{background:#3b82f6}
    
    .lock-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .timer{font-family:monospace;font-size:18px;font-weight:700;color:var(--warning)}
    
    /* Market Intelligence */
    .intel-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:8px 0}
    .intel-metric{
      text-align:center;padding:10px;background:rgba(255,255,255,.02);border-radius:8px;
      border:1px solid rgba(255,255,255,.06);
    }
    .intel-value{font-size:16px;font-weight:700;color:var(--gold)}
    .intel-label{font-size:10px;color:#9ca3af;margin-top:2px;text-transform:uppercase}
    
    .share-of-voice{
      margin:12px 0;padding:8px;background:rgba(242,169,34,.1);border-radius:8px;
      border:1px solid rgba(242,169,34,.3);
    }
    .voice-bar{
      height:8px;background:#333;border-radius:4px;overflow:hidden;margin:4px 0;
    }
    .voice-fill{
      height:100%;background:linear-gradient(90deg,var(--gold),#f7b32b);
      transition:width .8s ease;
    }
    
    /* Demographics with Real Census Data */
    .demo-overview{
      display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin:8px 0;
    }
    .demo-stat{
      text-align:center;padding:8px;background:rgba(5,144,140,.1);border-radius:6px;
    }
    .demo-number{font-size:14px;font-weight:700;color:var(--teal)}
    .demo-desc{font-size:10px;color:#9ca3af;margin-top:2px}
    
    .heatmap-controls{
      display:flex;gap:6px;margin:8px 0;flex-wrap:wrap;
    }
    .heatmap-btn{
      padding:6px 10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);
      color:#e6f1f1;border-radius:6px;cursor:pointer;font-size:11px;transition:all .2s;
    }
    .heatmap-btn.active{background:var(--teal);color:white}
    
    /* ROI Calculator with Bottom-Up Math */
    .roi-breakdown{
      background:rgba(242,169,34,.05);border:1px solid rgba(242,169,34,.2);
      border-radius:8px;padding:12px;margin:8px 0;
    }
    .roi-step{
      display:flex;justify-content:space-between;padding:4px 0;
      border-bottom:1px solid rgba(255,255,255,.1);
    }
    .roi-step:last-child{border-bottom:none;font-weight:700;color:var(--gold)}
    
    /* Competitor Intelligence */
    .competitor-alert{
      background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);
      border-radius:8px;padding:10px;margin:8px 0;
    }
    .competitor-spend{
      display:flex;justify-content:space-between;align-items:center;
      padding:6px 0;font-size:12px;
    }
    
    /* AI Analysis */
    .ai-output{
      min-height:120px;white-space:pre-wrap;line-height:1.5;
      background:rgba(255,255,255,.02);border-radius:8px;padding:12px;
      border:1px solid rgba(255,255,255,.08);
    }
    .loading{opacity:.6}
    
    .report-section{margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,.1)}
    
    .meta{color:#cfe8e3;font-size:13px;opacity:.85}
    
    @media (max-width:980px){
      .grid{grid-template-columns:1fr;gap:12px}
      #map{min-height:420px;height:60vh}
      input[type="text"]{width:100%}
      .intel-grid,.demo-overview{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo-dot"></div>
        <div>
          <div class="title">Territory Intelligence & ROI Engine‚Ñ¢</div>
          <div class="subtitle">AI-Powered Market Lock & Profit Forecast System</div>
        </div>
      </div>
      <div class="scarcity-alert">
        <span>üî•</span>
        <span id="territoriesRemaining">Only 4 founding territories left nationwide</span>
      </div>
    </header>

    <div class="toolbar">
      <input id="search" type="text" placeholder="Search dental practice or address‚Ä¶" />
      <select id="radius">
        <option value="10" selected>10 mi Protected Radius</option>
        <option value="12">12 mi Protected Radius</option>
        <option value="15">15 mi Protected Radius</option>
      </select>
      <button id="analyzeBtn" class="primary">üîç Analyze Territory</button>
    </div>

    <div class="grid">
      <div id="map"></div>

      <div class="panel">
        <!-- 1. Live Territory Mapping -->
        <div class="card">
          <h3>üó∫Ô∏è Live Territory Status</h3>
          <div id="territoryStatus" class="territory-status">
            <div style="font-weight:600;margin-bottom:4px">
              <span class="status-dot available"></span>
              üü¢ AVAILABLE - Ready to Lock
            </div>
            <div class="meta">This 10-mile protected area is unclaimed</div>
          </div>
          <div id="lockActions" class="lock-actions" style="display:none">
            <button id="lockBtn" class="lock-territory">üîí LOCK TERRITORY (Demo)</button>
            <button id="holdBtn">‚è∞ 48hr Hold (FREE)</button>
          </div>
          <div id="holdTimer" style="display:none">
            <div class="meta">Territory held for: <span class="timer" id="countdown">47:59:32</span></div>
          </div>
        </div>

        <!-- 2. AI-Powered Audience Qualification -->
        <div class="card">
          <h3>üë• Target Audience Intelligence</h3>
          <div class="demo-overview">
            <div class="demo-stat">
              <div class="demo-number" id="totalPop">--</div>
              <div class="demo-desc">Total Population</div>
            </div>
            <div class="demo-stat">
              <div class="demo-number" id="qualifiedAudience">--</div>
              <div class="demo-desc">Qualified Prospects</div>
            </div>
            <div class="demo-stat">
              <div class="demo-number" id="medianIncome">--</div>
              <div class="demo-desc">Median Income</div>
            </div>
          </div>
          <div class="heatmap-controls">
            <button class="heatmap-btn" id="incomeHeatmap">üí∞ Income Heatmap</button>
            <button class="heatmap-btn" id="ageHeatmap">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Age Demographics</button>
            <button class="heatmap-btn" id="behaviorHeatmap">üéØ Interest Targeting</button>
          </div>
          <div class="meta" id="audienceMeta">Census + Meta Audience Insights integration</div>
        </div>

        <!-- 3. Demand Ceiling Calculation -->
        <div class="card">
          <h3>üìä Market Demand Analysis</h3>
          <div class="intel-grid">
            <div class="intel-metric">
              <div class="intel-value" id="demandCeiling">--</div>
              <div class="intel-label">Annual Demand Ceiling</div>
            </div>
            <div class="intel-metric">
              <div class="intel-value" id="adoptionRate">--</div>
              <div class="intel-label">Adoption Rate</div>
            </div>
            <div class="intel-metric">
              <div class="intel-value" id="seasonalTrend">--</div>
              <div class="intel-label">Seasonal Trend</div>
            </div>
            <div class="intel-metric">
              <div class="intel-value" id="confidenceLevel">--</div>
              <div class="intel-label">Confidence Level</div>
            </div>
          </div>
          <div class="meta" id="demandMeta">Conservative projections with historical learning</div>
        </div>

        <!-- 4. Bottom-Up ROI Forecast -->
        <div class="card">
          <h3>üí∞ ROI Forecast Engine</h3>
          <div class="roi-breakdown">
            <div class="roi-step">
              <span>Monthly Ad Spend:</span>
              <span id="adSpend">$2,500</span>
            </div>
            <div class="roi-step">
              <span>Expected Clicks:</span>
              <span id="expectedClicks">--</span>
            </div>
            <div class="roi-step">
              <span>Qualified Leads:</span>
              <span id="qualifiedLeads">--</span>
            </div>
            <div class="roi-step">
              <span>Consultations:</span>
              <span id="consultations">--</span>
            </div>
            <div class="roi-step">
              <span>Invisalign Cases:</span>
              <span id="newCases">--</span>
            </div>
            <div class="roi-step">
              <span>Net Monthly Profit:</span>
              <span id="netProfit">--</span>
            </div>
          </div>
          <div class="meta">Updates after 14 days with live campaign data</div>
        </div>

        <!-- 5. Competitor Intelligence Layer -->
        <div class="card">
          <h3>üïµÔ∏è Competitor Intelligence</h3>
          <div class="competitor-alert">
            <div style="font-weight:600;margin-bottom:8px">‚ö†Ô∏è Active Competition Detected</div>
            <div class="competitor-spend">
              <span>üî¥ Invisalign Providers:</span>
              <span id="invisProviders">--</span>
            </div>
            <div class="competitor-spend">
              <span>üí∏ Est. Competitor Spend:</span>
              <span id="competitorSpend">--</span>
            </div>
            <div class="competitor-spend">
              <span>üìà Your Market Share:</span>
              <span id="marketShareCalc">--</span>
            </div>
          </div>
          <div class="share-of-voice">
            <div style="font-weight:600;margin-bottom:4px">Share of Voice Projection:</div>
            <div class="voice-bar">
              <div class="voice-fill" id="voiceFill" style="width:0%"></div>
            </div>
            <div class="meta" id="voiceDesc">Based on $2,500 monthly spend vs competition</div>
          </div>
        </div>

        <!-- 6. Real-Time Territory Lock -->
        <div class="card" style="display:none" id="lockConfirmation">
          <h3>üîê Territory Protected!</h3>
          <div class="territory-status locked">
            <div style="font-weight:600;margin-bottom:4px">
              <span class="status-dot locked"></span>
              üîí LOCKED & PROTECTED
            </div>
            <div class="meta">10-mile exclusive radius secured</div>
            <div class="meta">No competitors can access our video ads here</div>
          </div>
        </div>

        <!-- 7. AI-Generated Territory Analysis -->
        <div class="card">
          <h3>ü§ñ AI Territory Analysis</h3>
          <div id="aiAnalysis" class="ai-output">
            Run territory analysis to unlock AI-powered insights about this specific market opportunity, competitive positioning, and strategic recommendations.
          </div>
          <div class="report-section" id="reportSection" style="display:none">
            <button id="generateReport" class="primary" style="width:100%">
              üìÑ Generate Territory Report PDF
            </button>
          </div>
          <div class="meta">Powered by GPT-4 + proprietary market intelligence</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Google Maps + External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    window.GMAPS_KEY = "AIzaSyDkSEjq4ZORmiV2yYDC72m0iJYTBn4Vr3o";
    
    // Load Google Maps with required libraries
    (function(){
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${window.GMAPS_KEY}&libraries=places,geometry,visualization&callback=initTerritoryEngine`;
      script.async = true;
      document.head.appendChild(script);
    })();
  </script>

  <script>
    // ===========================================
    // ESTABLISHED SHOT TERRITORY ENGINE‚Ñ¢
    // AI-Powered Market Lock & Profit Forecast
    // ===========================================
    
    // Global State
    let map, placesService, selectedPlace = null;
    let territoryLocked = false, holdActive = false;
    let competitorMarkers = [], heatmapOverlays = [];
    let demographicData = null, competitorData = null;
    let holdTimer = null;
    
    // Simulated locked territories (in production, this comes from database)
    const existingTerritories = [
      {lat: 33.8488, lng: -84.3877, practice: "Smile Atlanta", rep: "Jessica M.", locked: true},
      {lat: 33.6488, lng: -84.4877, practice: "Buckhead Dental", rep: "Michael R.", locked: true},
      {lat: 34.1488, lng: -84.2877, practice: "Roswell Orthodontics", rep: "Sarah K.", locked: true},
      {lat: 33.5488, lng: -84.5877, practice: "Peachtree Smiles", rep: "David L.", locked: true}
    ];

    // Initialize Territory Engine
    window.initTerritoryEngine = function() {
      console.log('üöÄ Territory Intelligence Engine‚Ñ¢ Loading...');
      
      // Initialize map
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 33.7488, lng: -84.3877},
        zoom: 10,
        disableDefaultUI: true,
        styles: [
          {featureType: "poi", stylers: [{visibility: "off"}]},
          {featureType: "transit", stylers: [{visibility: "off"}]}
        ]
      });
      
      placesService = new google.maps.places.PlacesService(map);
      
      // Show existing locked territories
      renderLockedTerritories();
      
      // Setup autocomplete
      setupAddressSearch();
      
      // Bind event listeners
      bindEventListeners();
      
      // Start territory scarcity countdown
      startScarcityCounter();
      
      console.log('‚úÖ Territory Engine Ready');
    };

    // ===========================================
    // 1. LIVE TERRITORY MAPPING
    // ===========================================
    
    function renderLockedTerritories() {
      existingTerritories.forEach(territory => {
        // Draw protected circle
        const circle = new google.maps.Circle({
          strokeColor: '#ef4444',
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: '#ef4444',
          fillOpacity: 0.15,
          map: map,
          center: {lat: territory.lat, lng: territory.lng},
          radius: 10 * 1609.34 // 10 miles in meters
        });
        
        // Add marker
        const marker = new google.maps.Marker({
          position: {lat: territory.lat, lng: territory.lng},
          map: map,
          title: `PROTECTED: ${territory.practice}`,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: '#ef4444',
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 2,
            scale: 12
          }
        });
        
        // Info window
        marker.addListener('click', () => {
          const infoWindow = new google.maps.InfoWindow({
            content: `
              <div style="padding:8px;min-width:200px">
                <div style="font-weight:700;color:#ef4444;margin-bottom:4px">üîí TERRITORY LOCKED</div>
                <div><strong>${territory.practice}</strong></div>
                <div style="font-size:12px;color:#666">Protected by ${territory.rep}</div>
                <div style="font-size:12px;color:#666;margin-top:4px">10-mile exclusive radius</div>
                <div style="font-size:11px;color:#999;margin-top:6px">No competitors can run our ads here</div>
              </div>
            `
          });
          infoWindow.open(map, marker);
        });
      });
    }
    
    function checkTerritoryAvailability(location) {
      const center = {lat: location.lat(), lng: location.lng()};
      let available = true;
      let conflictTerritory = null;
      
      // Check distance from existing territories
      for (const territory of existingTerritories) {
        const distance = google.maps.geometry.spherical.computeDistanceBetween(
          new google.maps.LatLng(center.lat, center.lng),
          new google.maps.LatLng(territory.lat, territory.lng)
        );
        const distanceMiles = distance / 1609.34;
        
        if (distanceMiles < 20) { // 10mi radius each = 20mi separation needed
          available = false;
          conflictTerritory = territory;
          break;
        }
      }
      
      updateTerritoryStatus(available, conflictTerritory);
      return available;
    }
    
    function updateTerritoryStatus(available, conflict = null) {
      const statusDiv = document.getElementById('territoryStatus');
      const lockActions = document.getElementById('lockActions');
      
      if (available && !territoryLocked) {
        statusDiv.className = 'territory-status';
        statusDiv.innerHTML = `
          <div style="font-weight:600;margin-bottom:4px">
            <span class="status-dot available"></span>
            üü¢ AVAILABLE - Ready to Lock
          </div>
          <div class="meta">This 10-mile protected area is unclaimed</div>
          <div class="meta" style="color:var(--warning)">‚ö†Ô∏è Available to first founder who claims it</div>
        `;
        lockActions.style.display = 'flex';
      } else if (conflict) {
        statusDiv.className = 'territory-status competitor-blocked';
        statusDiv.innerHTML = `
          <div style="font-weight:600;margin-bottom:4px">
            <span class="status-dot blocked"></span>
            üö´ BLOCKED - Territory Conflict
          </div>
          <div class="meta">Overlaps with ${conflict.practice}</div>
          <div class="meta">Protected by ${conflict.rep}</div>
          <div class="meta" style="color:var(--warning)">Try a different location or smaller radius</div>
        `;
        lockActions.style.display = 'none';
      }
    }

    // ===========================================
    // 2. AI-POWERED AUDIENCE QUALIFICATION  
    // ===========================================
    
    async function getDemographicData(center, radiusMiles) {
      console.log('üìä Fetching real Census demographic data...');
      
      try {
        // Call our Census API endpoint
        const response = await fetch('/api/census-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            lat: center.lat(),
            lng: center.lng(),
            radius: radiusMiles
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          demographicData = result.demographics;
          updateDemographicUI();
          console.log('‚úÖ Real Census data loaded:', demographicData);
          return demographicData;
        } else {
          throw new Error(`Census API error: ${response.status}`);
        }
      } catch (error) {
        console.error('Census API failed, using fallback:', error);
        // Fallback to sophisticated simulation
        return getFallbackDemographics(center, radiusMiles);
      }
    }
    
    function getFallbackDemographics(center, radiusMiles) {
      // Sophisticated fallback when Census API fails
      const areaSqMiles = Math.PI * radiusMiles * radiusMiles;
      const populationDensity = getPopulationDensity(center);
      const totalPop = Math.floor(areaSqMiles * populationDensity);
      const medianIncome = getMedianIncome(center);
      const qualifiedPercent = calculateQualifiedPercent(medianIncome, center);
      
      return {
        totalPopulation: totalPop,
        qualifiedAudience: Math.floor(totalPop * qualifiedPercent),
        medianIncome: medianIncome,
        qualifiedPercent: qualifiedPercent,
        areaSqMiles: areaSqMiles,
        populationDensity: populationDensity,
        dataSource: 'Fallback Simulation'
      };
    }
    
    function getPopulationDensity(center) {
      // Realistic population density based on location
      // Metro areas have higher density
      const lat = center.lat, lng = center.lng;
      
      // Atlanta metro area
      if (lat > 33.4 && lat < 34.0 && lng > -84.8 && lng < -84.0) return 3200;
      // Suburban areas
      if (lat > 33.0 && lat < 34.5 && lng > -85.0 && lng < -83.5) return 2100;
      // Rural areas
      return 1200;
    }
    
    function getMedianIncome(center) {
      // Realistic income variation by location
      const lat = center.lat, lng = center.lng;
      const baseIncome = 52000;
      
      // Higher income areas (north Atlanta)
      if (lat > 33.8) return baseIncome + Math.random() * 25000 + 15000;
      // Lower income areas
      if (lat < 33.5) return baseIncome + Math.random() * 15000 - 5000;
      // Average areas
      return baseIncome + Math.random() * 20000;
    }
    
    function calculateQualifiedPercent(medianIncome, center) {
      let basePercent = 0.28; // 28% base qualified rate
      
      // Income adjustments
      if (medianIncome > 70000) basePercent += 0.08;
      if (medianIncome > 90000) basePercent += 0.05;
      if (medianIncome < 45000) basePercent -= 0.12;
      
      // Urban vs suburban adjustments
      const density = getPopulationDensity(center);
      if (density > 3000) basePercent += 0.05; // Urban bonus
      if (density < 1500) basePercent -= 0.08; // Rural penalty
      
      return Math.max(0.15, Math.min(0.45, basePercent));
    }
    
    function updateDemographicUI() {
      if (!demographicData) return;
      
      document.getElementById('totalPop').textContent = demographicData.totalPopulation.toLocaleString();
      document.getElementById('qualifiedAudience').textContent = demographicData.qualifiedAudience.toLocaleString();
      document.getElementById('medianIncome').textContent = `${Math.floor(demographicData.medianIncome / 1000)}k`;
      
      const qualifiedPercent = (demographicData.qualifiedPercent * 100).toFixed(1);
      document.getElementById('audienceMeta').textContent = 
        `${qualifiedPercent}% qualified Invisalign prospects (age 25-55, income >$50k, dental insurance)`;
    }

    // ===========================================
    // 3. DEMAND CEILING CALCULATION
    // ===========================================
    
    function calculateDemandCeiling() {
      if (!demographicData) return;
      
      const qualifiedAudience = demographicData.qualifiedAudience;
      
      // Historical adoption rates for Invisalign by market maturity
      const baseAdoptionRate = 0.024; // 2.4% annually
      let adoptionRate = baseAdoptionRate;
      
      // Adjust for income level
      if (demographicData.medianIncome > 70000) adoptionRate = 0.032;
      if (demographicData.medianIncome > 90000) adoptionRate = 0.038;
      if (demographicData.medianIncome < 45000) adoptionRate = 0.018;
      
      // Adjust for competition density
      const competitorDensity = competitorData ? competitorData.invisalignProviders / demographicData.areaSqMiles : 0.5;
      if (competitorDensity < 0.3) adoptionRate *= 1.2; // Less competition
      if (competitorDensity > 1.0) adoptionRate *= 0.8; // High competition
      
      const annualDemand = Math.floor(qualifiedAudience * adoptionRate);
      
      // Seasonal adjustments (Q1 highest, Q3 lowest)
      const currentMonth = new Date().getMonth();
      let seasonalMultiplier = 1.0;
      if (currentMonth >= 0 && currentMonth <= 2) seasonalMultiplier = 1.15; // Q1 boost
      if (currentMonth >= 6 && currentMonth <= 8) seasonalMultiplier = 0.85; // Q3 dip
      
      const seasonalDemand = Math.floor(annualDemand * seasonalMultiplier);
      
      // Confidence level based on data quality
      let confidence = 85; // Base confidence
      if (demographicData.populationDensity > 2000) confidence += 10; // Urban areas more predictable
      if (competitorData && competitorData.invisalignProviders > 0) confidence += 5; // More data available
      
      // Update UI
      document.getElementById('demandCeiling').textContent = seasonalDemand.toLocaleString();
      document.getElementById('adoptionRate').textContent = `${(adoptionRate * 100).toFixed(1)}%`;
      document.getElementById('seasonalTrend').textContent = 
        seasonalMultiplier > 1 ? '+15% (Peak Season)' : 
        seasonalMultiplier < 1 ? '-15% (Low Season)' : 'Stable';
      document.getElementById('confidenceLevel').textContent = `${confidence}%`;
      
      document.getElementById('demandMeta').textContent = 
        `Annual Invisalign demand ceiling with ${confidence}% confidence based on demographics + competition`;
      
      return {annualDemand, seasonalDemand, adoptionRate, confidence};
    }

    // ===========================================
    // 4. BOTTOM-UP ROI FORECAST
    // ===========================================
    
    function calculateROIForecast() {
      if (!demographicData || !competitorData) return;
      
      const monthlySpend = 2500;
      
      // Step 1: Ad Performance (based on dental industry benchmarks)
      const avgCPC = 8.50; // Dental/Invisalign CPC
      const expectedClicks = Math.floor(monthlySpend / avgCPC);
      
      // Step 2: Lead Generation
      const leadConversionRate = 0.085; // 8.5% click-to-lead
      const qualifiedLeads = Math.floor(expectedClicks * leadConversionRate);
      
      // Step 3: Consultation Booking
      const consultationRate = 0.65; // 65% of leads book consultation
      const consultations = Math.floor(qualifiedLeads * consultationRate);
      
      // Step 4: Case Conversion
      let caseConversionRate = 0.35; // 35% base conversion rate
      
      // Adjust for competition
      const marketShare = competitorData.ourMarketShare / 100;
      if (marketShare > 0.4) caseConversionRate *= 1.1; // Dominant position
      if (marketShare < 0.2) caseConversionRate *= 0.9; // Highly competitive
      
      // Adjust for demographics
      if (demographicData.medianIncome > 70000) caseConversionRate *= 1.15;
      if (demographicData.medianIncome < 45000) caseConversionRate *= 0.85;
      
      const newCases = Math.floor(consultations * caseConversionRate);
      
      // Step 5: Revenue Calculation
      const avgCaseValue = 4800; // Average Invisalign case value
      const grossRevenue = newCases * avgCaseValue;
      const operationalCosts = grossRevenue * 0.20; // 20% operational costs
      const netProfit = grossRevenue - monthlySpend - operationalCosts;
      
      // Update UI
      document.getElementById('expectedClicks').textContent = expectedClicks.toLocaleString();
      document.getElementById('qualifiedLeads').textContent = qualifiedLeads;
      document.getElementById('consultations').textContent = consultations;
      document.getElementById('newCases').textContent = newCases;
      document.getElementById('netProfit').textContent = `${netProfit.toLocaleString()}`;
      
      return {
        expectedClicks, qualifiedLeads, consultations, newCases, 
        grossRevenue, netProfit, roiMultiple: netProfit / monthlySpend
      };
    }

    // ===========================================
    // 5. COMPETITOR INTELLIGENCE LAYER
    // ===========================================
    
    async function getCompetitorIntelligence(center, radiusMiles) {
      console.log('üïµÔ∏è Analyzing competitor landscape...');
      
      // Get dental practices in area
      const practices = await getNearbyDentalPractices(center, radiusMiles);
      
      // Identify Invisalign providers
      const invisalignProviders = await identifyInvisalignProviders(center, radiusMiles);
      
      // Estimate competitor ad spend using Meta Ad Library data (simulated)
      const competitorSpend = await estimateCompetitorSpend(invisalignProviders);
      
      // Calculate market share
      const ourSpend = 2500;
      const totalMarketSpend = competitorSpend + ourSpend;
      const ourMarketShare = Math.round((ourSpend / totalMarketSpend) * 100);
      
      competitorData = {
        totalPractices: practices.length,
        invisalignProviders: invisalignProviders.length,
        competitorSpend: competitorSpend,
        ourMarketShare: ourMarketShare,
        shareOfVoice: ourMarketShare
      };
      
      updateCompetitorUI();
      return competitorData;
    }
    
    async function getNearbyDentalPractices(center, radiusMiles) {
      return new Promise((resolve) => {
        const request = {
          location: center,
          radius: radiusMiles * 1609.34,
          type: 'dentist'
        };
        
        placesService.nearbySearch(request, (results, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            resolve(results || []);
          } else {
            resolve([]);
          }
        });
      });
    }
    
    async function identifyInvisalignProviders(center, radiusMiles) {
      return new Promise((resolve) => {
        const request = {
          location: center,
          radius: radiusMiles * 1609.34,
          query: 'Invisalign dentist orthodontist'
        };
        
        placesService.textSearch(request, (results, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            // Filter for actual Invisalign providers
            const invisProviders = (results || []).filter(place => {
              const name = (place.name || '').toLowerCase();
              return name.includes('invisalign') || 
                     name.includes('orthodontic') || 
                     name.includes('clear aligner');
            });
            resolve(invisProviders);
          } else {
            resolve([]);
          }
        });
      });
    }
    
    async function estimateCompetitorSpend(invisalignProviders) {
      // Simulate Meta Ad Library analysis
      // In production, this would scrape actual competitor ads
      
      let totalSpend = 0;
      invisalignProviders.forEach(provider => {
        // Estimate spend based on practice size and rating
        const rating = provider.rating || 3.5;
        const reviewCount = provider.user_ratings_total || 50;
        
        let estimatedSpend = 1200; // Base spend
        
        // Adjust for practice quality indicators
        if (rating > 4.0) estimatedSpend += 600;
        if (reviewCount > 100) estimatedSpend += 400;
        if (reviewCount > 500) estimatedSpend += 800;
        
        // Random variation
        estimatedSpend += (Math.random() - 0.5) * 400;
        
        totalSpend += Math.max(600, estimatedSpend);
      });
      
      return Math.floor(totalSpend);
    }
    
    function updateCompetitorUI() {
      if (!competitorData) return;
      
      document.getElementById('invisProviders').textContent = competitorData.invisalignProviders;
      document.getElementById('competitorSpend').textContent = `${competitorData.competitorSpend.toLocaleString()}/mo`;
      document.getElementById('marketShareCalc').textContent = `${competitorData.ourMarketShare}%`;
      
      // Update share of voice visualization
      const voiceFill = document.getElementById('voiceFill');
      const voiceDesc = document.getElementById('voiceDesc');
      
      setTimeout(() => {
        voiceFill.style.width = `${competitorData.shareOfVoice}%`;
      }, 500);
      
      voiceDesc.textContent = `Your $2,500 = ${competitorData.shareOfVoice}% of total market ad spend`;
      
      // Show competitor warning if high competition
      if (competitorData.invisalignProviders > 5) {
        voiceDesc.innerHTML += ` <span style="color:var(--warning)">‚ö†Ô∏è High competition detected</span>`;
      }
    }

    // ===========================================
    // 6. REAL-TIME TERRITORY LOCK MECHANISM
    // ===========================================
    
    function lockTerritory() {
      if (!selectedPlace || territoryLocked) return;
      
      territoryLocked = true;
      
      // Update UI to show locked state
      const statusDiv = document.getElementById('territoryStatus');
      const lockActions = document.getElementById('lockActions');
      const lockConfirmation = document.getElementById('lockConfirmation');
      
      statusDiv.className = 'territory-status locked';
      statusDiv.innerHTML = `
        <div style="font-weight:600;margin-bottom:4px">
          <span class="status-dot locked"></span>
          üîí TERRITORY LOCKED!
        </div>
        <div class="meta">10-mile exclusive protection active</div>
        <div class="meta">Campaign launching rights secured</div>
        <div class="meta" style="color:var(--success)">‚úÖ No competitors can run our ads here</div>
      `;
      
      lockActions.style.display = 'none';
      lockConfirmation.style.display = 'block';
      
      // Update territory counter
      updateTerritoryCounter(-1);
      
      // Visual feedback on map
      if (map && selectedPlace) {
        const center = selectedPlace.geometry.location;
        const radius = parseInt(document.getElementById('radius').value);
        
        // Create locked territory circle
        new google.maps.Circle({
          strokeColor: '#10b981',
          strokeOpacity: 0.8,
          strokeWeight: 3,
          fillColor: '#10b981',
          fillOpacity: 0.1,
          map: map,
          center: center,
          radius: radius * 1609.34
        });
        
        // Update marker to locked state
        new google.maps.Marker({
          position: center,
          map: map,
          title: 'YOUR PROTECTED TERRITORY',
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: '#10b981',
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 3,
            scale: 15
          }
        });
      }
      
      console.log('üîí Territory locked successfully!');
    }
    
    function holdTerritory() {
      if (!selectedPlace || holdActive) return;
      
      holdActive = true;
      
      const statusDiv = document.getElementById('territoryStatus');
      const holdTimerDiv = document.getElementById('holdTimer');
      const holdBtn = document.getElementById('holdBtn');
      
      statusDiv.className = 'territory-status hold';
      statusDiv.innerHTML = `
        <div style="font-weight:600;margin-bottom:4px">
          <span class="status-dot hold"></span>
          ‚è∞ 48-HOUR HOLD ACTIVE
        </div>
        <div class="meta">Territory reserved for your decision</div>
        <div class="meta" style="color:var(--warning)">‚ö†Ô∏è Other reps cannot claim this area</div>
      `;
      
      holdBtn.textContent = '‚è∞ Hold Active';
      holdBtn.disabled = true;
      holdTimerDiv.style.display = 'block';
      
      // Start 48-hour countdown
      startHoldCountdown();
      
      console.log('‚è∞ 48-hour territory hold activated');
    }
    
    function startHoldCountdown() {
      let timeLeft = 48 * 60 * 60; // 48 hours in seconds
      const countdownEl = document.getElementById('countdown');
      
      holdTimer = setInterval(() => {
        timeLeft--;
        
        const hours = Math.floor(timeLeft / 3600);
        const minutes = Math.floor((timeLeft % 3600) / 60);
        const seconds = timeLeft % 60;
        
        countdownEl.textContent = 
          `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
          clearInterval(holdTimer);
          expireHold();
        }
      }, 1000);
    }
    
    function expireHold() {
      holdActive = false;
      document.getElementById('countdown').textContent = 'EXPIRED';
      document.getElementById('countdown').style.color = 'var(--danger)';
      
      // Reset to available state
      updateTerritoryStatus(true);
    }

    // ===========================================
    // 7. AI-GENERATED TERRITORY ANALYSIS
    // ===========================================
    
    async function generateAIAnalysis() {
      if (!selectedPlace || !demographicData || !competitorData) {
        console.log('Missing data for AI analysis');
        return;
      }
      
      const aiOutput = document.getElementById('aiAnalysis');
      aiOutput.classList.add('loading');
      aiOutput.textContent = 'AI analyzing territory data...';
      
      const analysisData = {
        practice: {
          name: selectedPlace.name,
          address: selectedPlace.formatted_address,
          location: {
            lat: selectedPlace.geometry.location.lat(),
            lng: selectedPlace.geometry.location.lng()
          }
        },
        demographics: demographicData,
        competitors: competitorData,
        roi: calculateROIForecast(),
        demand: calculateDemandCeiling()
      };
      
      try {
        const response = await fetch('/api/generate-insight', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            territory_analysis: analysisData,
            prompt_type: 'territory_intelligence'
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          aiOutput.textContent = result.insight || generateFallbackAnalysis(analysisData);
        } else {
          aiOutput.textContent = generateFallbackAnalysis(analysisData);
        }
      } catch (error) {
        console.error('AI Analysis error:', error);
        aiOutput.textContent = generateFallbackAnalysis(analysisData);
      } finally {
        aiOutput.classList.remove('loading');
        document.getElementById('reportSection').style.display = 'block';
      }
    }
    
    function generateFallbackAnalysis(data) {
      const practice = data.practice.name || 'This practice';
      const qualified = data.demographics.qualifiedAudience.toLocaleString();
      const income = `${Math.floor(data.demographics.medianIncome / 1000)}k`;
      const competitors = data.competitors.invisalignProviders;
      const marketShare = data.competitors.ourMarketShare;
      const cases = data.roi.newCases;
      const profit = data.roi.netProfit;
      
      return `TERRITORY INTELLIGENCE ANALYSIS:

${practice} represents a HIGH-VALUE opportunity with ${qualified} qualified Invisalign prospects (median income: ${income}) and only ${competitors} direct competitors currently advertising.

KEY STRATEGIC ADVANTAGES:
‚Ä¢ Market Share Projection: ${marketShare}% with $2,500 monthly investment
‚Ä¢ Expected Monthly Cases: ${cases} new Invisalign starts
‚Ä¢ Projected Net Profit: ${profit.toLocaleString()}/month
‚Ä¢ ROI Multiple: ${(profit/2500).toFixed(1)}x return on ad spend

COMPETITIVE POSITIONING:
With ${competitors} active Invisalign advertisers spending an estimated ${data.competitors.competitorSpend.toLocaleString()}/month total, your $2,500 investment captures ${marketShare}% share of voice in this territory.

TERRITORY LOCK RECOMMENDATION:
IMMEDIATE ACTION REQUIRED. This territory shows strong profit potential with limited competition. Once locked, no other practices can access our proprietary actor-led video ad system within the 10-mile radius.

Lock this territory today to secure exclusive access to these ${qualified} high-value prospects.`;
    }

    // ===========================================
    // TERRITORY REPORT PDF GENERATION
    // ===========================================
    
    function generateTerritoryReport() {
      if (!selectedPlace || !demographicData || !competitorData) {
        alert('Please run territory analysis first');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Header
      doc.setFillColor(1, 46, 64);
      doc.rect(0, 0, 210, 35, 'F');
      
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(20);
      doc.setFont('helvetica', 'bold');
      doc.text('TERRITORY INTELLIGENCE REPORT', 20, 20);
      doc.setFontSize(12);
      doc.text('Established Shot ‚Äî AI-Powered Market Analysis', 20, 28);
      
      // Practice Details
      doc.setTextColor(0, 0, 0);
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text('PRACTICE TERRITORY ANALYSIS', 20, 50);
      
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      const practiceInfo = [
        `Practice: ${selectedPlace.name}`,
        `Address: ${selectedPlace.formatted_address}`,
        `Protected Radius: ${document.getElementById('radius').value} miles`,
        `Analysis Date: ${new Date().toLocaleDateString()}`,
        `Territory Status: ${territoryLocked ? 'LOCKED & PROTECTED' : 'AVAILABLE FOR LOCKING'}`
      ];
      
      practiceInfo.forEach((line, i) => {
        doc.text(line, 20, 60 + (i * 6));
      });
      
      // Demographics Section
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('DEMOGRAPHIC INTELLIGENCE', 20, 100);
      
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      const demoInfo = [
        `Total Population: ${demographicData.totalPopulation.toLocaleString()}`,
        `Qualified Prospects: ${demographicData.qualifiedAudience.toLocaleString()}`,
        `Median Income: ${Math.floor(demographicData.medianIncome / 1000)}k`,
        `Market Penetration: ${(demographicData.qualifiedPercent * 100).toFixed(1)}% qualified rate`
      ];
      
      demoInfo.forEach((line, i) => {
        doc.text(line, 20, 110 + (i * 6));
      });
      
      // Competition Analysis
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('COMPETITIVE LANDSCAPE', 20, 140);
      
      const compInfo = [
        `Direct Invisalign Competitors: ${competitorData.invisalignProviders}`,
        `Estimated Competitor Spend: ${competitorData.competitorSpend.toLocaleString()}/month`,
        `Your Projected Market Share: ${competitorData.ourMarketShare}%`,
        `Share of Voice: ${competitorData.shareOfVoice}% with $2,500/month spend`
      ];
      
      compInfo.forEach((line, i) => {
        doc.text(line, 20, 150 + (i * 6));
      });
      
      // ROI Projections
      const roi = calculateROIForecast();
      doc.setFillColor(242, 169, 34, 0.1);
      doc.rect(20, 175, 170, 35, 'F');
      
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('ROI PROJECTIONS', 25, 185);
      
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      const roiInfo = [
        `Monthly Ad Spend: $2,500`,
        `Expected New Cases: ${roi.newCases} Invisalign starts`,
        `Gross Revenue: ${roi.grossRevenue.toLocaleString()}`,
        `Net Monthly Profit: ${roi.netProfit.toLocaleString()}`,
        `ROI Multiple: ${roi.roiMultiple.toFixed(1)}x return`
      ];
      
      roiInfo.forEach((line, i) => {
        doc.text(line, 25, 195 + (i * 5));
      });
      
      // Territory Protection Message
      doc.setFillColor(16, 185, 129);
      doc.rect(20, 220, 170, 25, 'F');
      
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      doc.text('üîí EXCLUSIVE TERRITORY PROTECTION', 25, 230);
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text('Lock this territory for $2,500/month and gain exclusive access to our', 25, 237);
      doc.text('actor-led video ad system. No competitors can run our ads in your radius.', 25, 242);
      
      // Footer
      doc.setFillColor(1, 46, 64);
      doc.rect(0, 250, 210, 20, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(8);
      doc.text('Established Shot Territory Intelligence Engine‚Ñ¢ ‚Äî Confidential Analysis', 20, 258);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 264);
      
      // Save PDF
      const filename = `Territory_Report_${selectedPlace.name.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
      doc.save(filename);
      
      // UI feedback
      const btn = document.getElementById('generateReport');
      const originalText = btn.textContent;
      btn.textContent = '‚úÖ Report Downloaded!';
      btn.style.background = '#10b981';
      
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
      }, 3000);
    }

    // ===========================================
    // EVENT HANDLERS & UTILITIES
    // ===========================================
    
    function setupAddressSearch() {
      const searchInput = document.getElementById('search');
      const autocomplete = new google.maps.places.Autocomplete(searchInput, {
        fields: ['place_id', 'name', 'formatted_address', 'geometry'],
        types: ['establishment']
      });
      
      autocomplete.addListener('place_changed', async () => {
        const place = autocomplete.getPlace();
        if (!place || !place.geometry) return;
        
        selectedPlace = place;
        
        // Check territory availability
        const available = checkTerritoryAvailability(place.geometry.location);
        
        if (available) {
          // Center map on selection
          map.setCenter(place.geometry.location);
          map.setZoom(12);
          
          // Add marker for selected practice
          new google.maps.Marker({
            position: place.geometry.location,
            map: map,
            title: place.name,
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              fillColor: '#05908C',
              fillOpacity: 1,
              strokeColor: '#ffffff',
              strokeWeight: 2,
              scale: 10
            }
          });
        }
      });
    }
    
    function bindEventListeners() {
      // Main analyze button
      document.getElementById('analyzeBtn').addEventListener('click', async () => {
        if (!selectedPlace) {
          alert('Please select a practice first');
          return;
        }
        
        const radiusMiles = parseInt(document.getElementById('radius').value);
        const center = selectedPlace.geometry.location;
        
        console.log('üîç Starting territory analysis...');
        
        try {
          // Run all analysis functions
          await getDemographicData(center, radiusMiles);
          await getCompetitorIntelligence(center, radiusMiles);
          calculateDemandCeiling();
          calculateROIForecast();
          await generateAIAnalysis();
          
          console.log('‚úÖ Territory analysis complete!');
        } catch (error) {
          console.error('Analysis error:', error);
          alert('Analysis failed. Please try again.');
        }
      });
      
      // Territory locking buttons
      document.getElementById('lockBtn').addEventListener('click', lockTerritory);
      document.getElementById('holdBtn').addEventListener('click', holdTerritory);
      
      // Report generation
      document.getElementById('generateReport').addEventListener('click', generateTerritoryReport);
      
      // Heatmap controls
      document.getElementById('incomeHeatmap').addEventListener('click', toggleIncomeHeatmap);
      document.getElementById('ageHeatmap').addEventListener('click', toggleAgeHeatmap);
      document.getElementById('behaviorHeatmap').addEventListener('click', toggleBehaviorHeatmap);
    }
    
    function startScarcityCounter() {
      // Decrease territory count periodically to create urgency
      setInterval(() => {
        if (Math.random() < 0.1) { // 10% chance every 30 seconds
          updateTerritoryCounter(-1);
        }
      }, 30000);
    }
    
    function updateTerritoryCounter(change) {
      const counter = document.getElementById('territoriesRemaining');
      const current = parseInt(counter.textContent.match(/\d+/)[0]);
      const newCount = Math.max(1, current + change);
      
      if (newCount !== current) {
        counter.textContent = `Only ${newCount} founding territories left nationwide`;
        
        // Add urgency styling when count gets low
        if (newCount <= 3) {
          counter.parentElement.style.background = 'rgba(239,68,68,.25)';
          counter.parentElement.style.animation = 'urgentPulse 2s infinite';
        }
      }
    }
    
    // Heatmap toggle functions (placeholder implementations)
    function toggleIncomeHeatmap() {
      const btn = document.getElementById('incomeHeatmap');
      btn.classList.toggle('active');
      // Implementation would show/hide income-based heatmap overlay
    }
    
    function toggleAgeHeatmap() {
      const btn = document.getElementById('ageHeatmap');
      btn.classList.toggle('active');
      // Implementation would show/hide age demographic overlay
    }
    
    function toggleBehaviorHeatmap() {
      const btn = document.getElementById('behaviorHeatmap');
      btn.classList.toggle('active');
      // Implementation would show/hide behavioral interest overlay
    }
    
    console.log('üöÄ Established Shot Territory Intelligence Engine‚Ñ¢ Ready');
  </script>
</body>
</html>
