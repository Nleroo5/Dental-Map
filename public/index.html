<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Territory Intelligence & ROI Engine‚Ñ¢ ‚Äî Established Shot</title>

  <!-- Brand fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Young+Serif&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Styling -->
  <style>
    :root{
      --navy:#012E40;
      --gold:#F2A922;
      --teal:#05908C;
      --mint:#85C7B3;
      --foam:#EEF4D9;
      --ink:#0b1720;
      --card:#06222e;
      --ring:rgba(242,169,34,.5);
      --success:#10b981;
      --warning:#f59e0b;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:#e9f3f3;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(5,144,140,.35), transparent 60%),
        radial-gradient(900px 600px at 110% 40%, rgba(242,169,34,.18), transparent 60%),
        linear-gradient(180deg, #031923 0%, #03161d 100%);
    }
    .wrap{
      max-width:1400px;margin:0 auto;padding:24px 16px 40px;
    }
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;align-items:center;gap:12px;
    }
    .logo-dot{
      width:14px;height:14px;border-radius:50%;background:var(--gold);box-shadow:0 0 0 4px rgba(242,169,34,.2);
    }
    .title{font-family:"Young Serif",serif;font-size:22px;letter-spacing:.2px}
    .subtitle{color:#b8d8d3;font-size:13px;margin-top:-2px}
    .scarcity-bar{
      display:flex;align-items:center;gap:8px;
      background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.25);
      padding:8px 12px;border-radius:8px;color:#fca5a5;font-weight:600;font-size:13px;
    }
    .pulse{animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
    
    .toolbar{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
      background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);
      padding:10px;border-radius:12px;
      box-shadow:0 6px 16px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.04);
    }
    input[type="text"]{
      width:360px;max-width:80vw;
      background:#081f29;border:1px solid rgba(255,255,255,.12);color:#e6f1f1;
      padding:10px 12px;border-radius:10px;outline:0;
    }
    select,button{
      appearance:none;
      background:#092431;border:1px solid rgba(255,255,255,.12);color:#e6f1f1;
      padding:10px 12px;border-radius:10px;cursor:pointer;transition:all .2s;
    }
    button.primary{
      background:var(--gold);border-color:var(--gold);color:#0d1012;font-weight:700;
    }
    button.lock{
      background:var(--success);border-color:var(--success);color:white;font-weight:700;
      animation:glow 2s infinite;
    }
    button.locked{
      background:#374151;border-color:#4b5563;color:#9ca3af;cursor:not-allowed;
    }
    @keyframes glow{0%,100%{box-shadow:0 0 8px rgba(16,185,129,.4)}50%{box-shadow:0 0 16px rgba(16,185,129,.8)}}
    
    .grid{
      display:grid;grid-template-columns:1.4fr 1fr;gap:14px;margin-top:10px;
    }
    #map{
      width:100%;height:75vh;min-height:560px;border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 8px 24px rgba(0,0,0,.35);
      overflow:hidden;background:#05171f;
    }
    .panel{
      display:flex;flex-direction:column;gap:12px;
    }
    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:14px 14px;
      box-shadow:0 10px 24px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .card h3{
      margin:0 0 8px 0;font-family:"Young Serif",serif;font-weight:400;color:#f3f7f6;
      display:flex;align-items:center;gap:8px;
    }
    .status-dot{
      width:8px;height:8px;border-radius:50%;
    }
    .status-dot.available{background:var(--success);animation:pulse 2s infinite}
    .status-dot.locked{background:var(--danger)}
    .status-dot.analyzing{background:var(--warning);animation:pulse 1s infinite}
    
    .territory-status{
      padding:12px;border-radius:10px;margin-bottom:12px;
      background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);
    }
    .territory-status.locked{
      background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.2);
    }
    .territory-status.hold{
      background:rgba(245,158,11,.08);border-color:rgba(245,158,11,.2);
    }
    
    .lock-controls{
      display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;
    }
    .statrow{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;font-weight:600;background:#0b2a35;border:1px solid rgba(255,255,255,.10)
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.teal{background:var(--teal)}
    .dot.navy{background:#0c3141}
    .dot.gold{background:var(--gold)}
    .badge{
      padding:8px 12px;border-radius:10px;font-weight:700;letter-spacing:.2px;
      background:#0b2a35;border:1px solid rgba(255,255,255,.1);
    }
    .badge.low{background:rgba(5,144,140,.15);border-color:rgba(5,144,140,.35);color:#b8ffef}
    .badge.med{background:rgba(242,169,34,.12);border-color:rgba(242,169,34,.45);color:#ffe9b6}
    .badge.high{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.22);color:#f4f7f8}
    .meta{color:#cfe8e3;font-size:13px;opacity:.85}
    .footer-note{color:#a8c7c0;font-size:12px;opacity:.8}
    .ai{min-height:180px;white-space:pre-wrap;line-height:1.45;}
    .loading{opacity:.6}
    
    .roi-grid{
      display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px;
    }
    .roi-metric{
      text-align:center;padding:12px;background:rgba(255,255,255,.02);border-radius:8px;
    }
    .roi-value{font-size:20px;font-weight:700;color:var(--gold)}
    .roi-label{font-size:11px;color:#9ca3af;margin-top:2px}
    
    .timer{
      font-family:monospace;font-size:18px;font-weight:700;color:var(--warning);
    }
    
    @media (max-width:980px){
      .grid{grid-template-columns:1fr;gap:12px}
      #map{min-height:420px;height:60vh}
      input[type="text"]{width:100%}
      .roi-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo-dot"></div>
        <div>
          <div class="title">Territory Intelligence & ROI Engine‚Ñ¢</div>
          <div class="subtitle">AI-Powered Market Lock & Profit Forecast System</div>
        </div>
      </div>
      <div class="scarcity-bar">
        <span class="pulse">üî•</span>
        <span id="territoriesLeft">7 founding territories remaining nationwide</span>
      </div>
    </header>

    <div class="toolbar">
      <input id="search" type="text" placeholder="Search dental practice or address‚Ä¶" />
      <select id="radius">
        <option value="8">8 mi</option>
        <option value="10" selected>10 mi</option>
        <option value="12">12 mi</option>
      </select>
      <button id="go" class="primary">Analyze Territory</button>
    </div>

    <div class="grid">
      <div id="map"></div>

      <div class="panel">
        <!-- Territory Status Card -->
        <div class="card">
          <h3><span id="statusDot" class="status-dot available"></span>Territory Status</h3>
          <div id="territoryStatus" class="territory-status">
            <div style="font-weight:600;margin-bottom:4px">üü¢ Available Territory</div>
            <div class="meta">This 10-mile protected area is ready to lock</div>
          </div>
          <div id="lockControls" class="lock-controls" style="display:none">
            <button id="lockBtn" class="lock">üîí Lock Territory ($2,500/mo)</button>
            <button id="holdBtn">‚è∞ 48hr Hold (Free)</button>
          </div>
        </div>

        <!-- Practice Info -->
        <div class="card">
          <h3>Practice Details</h3>
          <div id="practiceName" class="meta">Select a practice to begin analysis.</div>
          <div id="practiceAddr" class="meta"></div>
          <div id="practiceRating" class="meta"></div>
        </div>

        <!-- Competition & Market Share -->
        <div class="card">
          <h3>Market Intelligence</h3>
          <div class="statrow">
            <span class="chip"><span class="dot teal"></span><span id="dentistCount">0</span>&nbsp;Dentists</span>
            <span class="chip"><span class="dot navy"></span><span id="orthoCount">0</span>&nbsp;Orthodontists</span>
            <span class="chip"><span class="dot gold"></span><span id="invisCount">0</span>&nbsp;Invisalign ads</span>
            <span class="chip">Share: <span id="marketShare">0%</span></span>
          </div>
          <div style="margin-top:10px">
            <span id="densityBadge" class="badge">Market Density ‚Äî analyzing...</span>
          </div>
          <div class="meta" style="margin-top:8px" id="nearestMeta"></div>
        </div>

        <!-- ROI Forecast -->
        <div class="card">
          <h3>ROI Forecast</h3>
          <div class="roi-grid">
            <div class="roi-metric">
              <div class="roi-value" id="monthlyCases">--</div>
              <div class="roi-label">Cases/Month</div>
            </div>
            <div class="roi-metric">
              <div class="roi-value" id="monthlyProfit">--</div>
              <div class="roi-label">Net Profit/Month</div>
            </div>
            <div class="roi-metric">
              <div class="roi-value" id="roiMultiple">--</div>
              <div class="roi-label">ROI Multiple</div>
            </div>
            <div class="roi-metric">
              <div class="roi-value" id="breakEven">--</div>
              <div class="roi-label">Break Even</div>
            </div>
          </div>
          <div class="meta" style="margin-top:8px">Based on $2,500/mo ad spend + 2% market adoption</div>
        </div>

        <!-- AI Territory Analysis -->
        <div class="card">
          <h3>AI Territory Analysis</h3>
          <div id="ai" class="ai">Run territory analysis to see AI-powered insights and profit projections.</div>
          <div class="footer-note">Powered by GPT-4 + proprietary market intelligence algorithms</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Google Maps -->
  <script>
    window.__GMAPS_API_KEY__ = "AIzaSyDkSEjq4ZORmiV2yYDC72m0iJYTBn4Vr3o";
  </script>
  <script>
    (function loadGmaps(){
      const s = document.createElement('script');
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(window.__GMAPS_API_KEY__)}&libraries=places,geometry&callback=initMap`;
      s.async = true; s.defer = true;
      document.head.appendChild(s);
    })();
  </script>

  <script>
  // ---------- Globals & State
  const BRAND = { navy:"#012E40", gold:"#F2A922", teal:"#05908C", success:"#10b981", danger:"#ef4444" };
  const $ = (id)=>document.getElementById(id);

  let map, placesService, mainMarker, radiusCircle, infoWin;
  let competitorMarkers = [];
  let selectedPlace = null;
  let territoryLocked = false;
  let holdTimer = null;

  // Simulated locked territories (in real app, this comes from database)
  const lockedTerritories = [
    {lat: 33.8488, lng: -84.3877, practice: "Atlanta Dental Group", rep: "Sarah M."},
    {lat: 33.6488, lng: -84.4877, practice: "Buckhead Orthodontics", rep: "Mike R."},
    {lat: 34.1488, lng: -84.2877, practice: "North Atlanta Smiles", rep: "Jennifer L."}
  ];

  // ---------- Google Maps Setup
  window.initMap = function(){
    const center = { lat: 33.7488, lng: -84.3877 };
    map = new google.maps.Map(document.getElementById('map'), {
      center, zoom: 10, disableDefaultUI: true,
      styles:[{featureType:"poi",stylers:[{visibility:"off"}]}]
    });
    placesService = new google.maps.places.PlacesService(map);
    infoWin = new google.maps.InfoWindow();

    // Show locked territories on map
    renderLockedTerritories();

    // Autocomplete
    const ac = new google.maps.places.Autocomplete($('search'), {
      fields: ["place_id","name","formatted_address","geometry"],
      types: ["establishment"]
    });

    ac.addListener('place_changed', ()=>{
      const place = ac.getPlace();
      if(!place || !place.geometry) return;
      selectedPlace = place;
      updatePracticeInfo(place);
      centerOn(place.geometry.location);
      checkTerritoryAvailability(place.geometry.location);
      fetchPracticeDetails(place.place_id);
    });

    $('go').addEventListener('click', runTerritoryAnalysis);
    $('lockBtn').addEventListener('click', lockTerritory);
    $('holdBtn').addEventListener('click', holdTerritory);
    $('search').addEventListener('keydown', (e)=>{ if(e.key==='Enter') runTerritoryAnalysis(); });
  };

  // ---------- Territory Locking System
  function renderLockedTerritories(){
    lockedTerritories.forEach(territory => {
      const circle = new google.maps.Circle({
        strokeColor: BRAND.danger,
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: BRAND.danger,
        fillOpacity: 0.15,
        map,
        center: {lat: territory.lat, lng: territory.lng},
        radius: 10 * 1609.34 // 10 miles
      });

      const marker = new google.maps.Marker({
        position: {lat: territory.lat, lng: territory.lng},
        map,
        title: `LOCKED: ${territory.practice}`,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          fillColor: BRAND.danger,
          fillOpacity: 1,
          strokeColor: "#ffffff",
          strokeWeight: 2,
          scale: 10
        }
      });

      marker.addListener('click', ()=>{
        infoWin.setContent(`
          <div style="min-width:200px">
            <div style="font-weight:700;color:#ef4444;margin-bottom:4px">üîí TERRITORY LOCKED</div>
            <div><strong>${territory.practice}</strong></div>
            <div style="font-size:12px;color:#666">Protected by ${territory.rep}</div>
            <div style="font-size:12px;color:#666;margin-top:4px">10-mile exclusive radius</div>
          </div>
        `);
        infoWin.open({ map, anchor: marker });
      });
    });
  }

  function checkTerritoryAvailability(location){
    const center = {lat: location.lat(), lng: location.lng()};
    let isAvailable = true;
    let conflictTerritory = null;

    // Check for conflicts with locked territories
    for(const territory of lockedTerritories){
      const distance = google.maps.geometry.spherical.computeDistanceBetween(
        new google.maps.LatLng(center.lat, center.lng),
        new google.maps.LatLng(territory.lat, territory.lng)
      );
      const distanceMiles = distance / 1609.34;
      
      if(distanceMiles < 20){ // 10 mile radius each = 20 mile separation needed
        isAvailable = false;
        conflictTerritory = territory;
        break;
      }
    }

    updateTerritoryStatus(isAvailable, conflictTerritory);
  }

  function updateTerritoryStatus(isAvailable, conflictTerritory = null){
    const statusDiv = $('territoryStatus');
    const statusDot = $('statusDot');
    const lockControls = $('lockControls');

    if(isAvailable){
      statusDiv.className = 'territory-status';
      statusDiv.innerHTML = `
        <div style="font-weight:600;margin-bottom:4px">üü¢ Available Territory</div>
        <div class="meta">This 10-mile protected area is ready to lock</div>
      `;
      statusDot.className = 'status-dot available';
      lockControls.style.display = 'flex';
    } else {
      statusDiv.className = 'territory-status locked';
      statusDiv.innerHTML = `
        <div style="font-weight:600;margin-bottom:4px">üî¥ Territory Unavailable</div>
        <div class="meta">Conflicts with ${conflictTerritory?.practice || 'existing territory'}</div>
        <div class="meta">Protected by ${conflictTerritory?.rep || 'another founder'}</div>
      `;
      statusDot.className = 'status-dot locked';
      lockControls.style.display = 'none';
    }
  }

  function lockTerritory(){
    if(!selectedPlace) return;
    
    territoryLocked = true;
    const statusDiv = $('territoryStatus');
    const statusDot = $('statusDot');
    const lockBtn = $('lockBtn');
    
    statusDiv.className = 'territory-status locked';
    statusDiv.innerHTML = `
      <div style="font-weight:600;margin-bottom:4px">üîí Territory Locked!</div>
      <div class="meta">10-mile exclusive protection active</div>
      <div class="meta">Campaign launching rights secured</div>
    `;
    statusDot.className = 'status-dot locked';
    lockBtn.textContent = '‚úÖ Territory Secured';
    lockBtn.className = 'locked';
    
    // Update scarcity counter
    const current = parseInt($('territoriesLeft').textContent.match(/\d+/)[0]);
    $('territoriesLeft').textContent = `${current - 1} founding territories remaining nationwide`;
    
    // Change radius circle to locked styling
    if(radiusCircle){
      radiusCircle.setOptions({
        strokeColor: BRAND.success,
        fillColor: BRAND.success,
        fillOpacity: 0.12
      });
    }
  }

  function holdTerritory(){
    if(!selectedPlace) return;
    
    const statusDiv = $('territoryStatus');
    const holdBtn = $('holdBtn');
    
    statusDiv.className = 'territory-status hold';
    statusDiv.innerHTML = `
      <div style="font-weight:600;margin-bottom:4px">‚è∞ 48-Hour Hold Active</div>
      <div class="meta">Territory reserved for decision</div>
      <div class="meta">Time remaining: <span id="holdTimer" class="timer">47:59:32</span></div>
    `;
    
    holdBtn.textContent = '‚è∞ Hold Active';
    holdBtn.disabled = true;
    
    // Start countdown timer
    startHoldTimer();
  }

  function startHoldTimer(){
    let timeLeft = 48 * 60 * 60; // 48 hours in seconds
    const timer = $('holdTimer');
    
    holdTimer = setInterval(()=>{
      timeLeft--;
      const hours = Math.floor(timeLeft / 3600);
      const minutes = Math.floor((timeLeft % 3600) / 60);
      const seconds = timeLeft % 60;
      
      timer.textContent = `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
      
      if(timeLeft <= 0){
        clearInterval(holdTimer);
        timer.textContent = 'EXPIRED';
        timer.style.color = BRAND.danger;
      }
    }, 1000);
  }

  // ---------- Practice & Analysis Functions
  function updatePracticeInfo(place){
    $('practiceName').textContent = place.name || '‚Äî';
    $('practiceAddr').textContent = place.formatted_address || '';
    $('practiceRating').textContent = 'Fetching details...';
  }

  function centerOn(latlng){
    if(mainMarker) mainMarker.setMap(null);
    if(radiusCircle) radiusCircle.setMap(null);

    mainMarker = new google.maps.Marker({
      position: latlng, map, title: 'Selected Practice',
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor: BRAND.teal, fillOpacity: .95,
        strokeColor: "#003e4f", strokeWeight: 2, scale: 8
      }
    });

    const miles = +$('radius').value;
    radiusCircle = new google.maps.Circle({
      strokeColor: BRAND.gold, strokeOpacity: 0.9, strokeWeight: 2,
      fillColor: BRAND.gold, fillOpacity: 0.08, map,
      center: latlng, radius: miles * 1609.34
    });

    map.fitBounds(radiusCircle.getBounds());
  }

  function fetchPracticeDetails(placeId){
    placesService.getDetails({
      placeId, fields:["name","formatted_address","rating","user_ratings_total","geometry"]
    }, (res, status)=>{
      if(status!==google.maps.places.PlacesServiceStatus.OK || !res){
        $('practiceRating').textContent = 'Rating: n/a';
        return;
      }
      const r = res.rating ?? '‚Äî';
      const n = res.user_ratings_total ?? 0;
      $('practiceRating').textContent = `Google rating: ${r} (${n} reviews)`;
    });
  }

  // ---------- Enhanced Analysis Functions
  async function runTerritoryAnalysis(){
    if(!selectedPlace){
      $('ai').textContent = 'Please select a practice first.';
      return;
    }

    $('ai').classList.add('loading');
    $('ai').textContent = 'Running AI territory analysis...';
    $('statusDot').className = 'status-dot analyzing';

    const miles = +$('radius').value;
    const center = selectedPlace.geometry.location;
    const centerLL = { lat:center.lat(), lng:center.lng() };

    // Clear old markers
    competitorMarkers.forEach(m=>m.setMap(null));
    competitorMarkers = [];

    // Enhanced competitor analysis
    const analysis = await performCompetitorAnalysis(center, miles);
    await updateROIForecast(analysis, miles);
    await generateAIInsights(selectedPlace, analysis, miles);

    $('statusDot').className = 'status-dot available';
  }

  async function performCompetitorAnalysis(center, miles){
    const radiusMeters = miles * 1609.34;

    // Simulated enhanced competitor data
    const dentistCount = Math.floor(Math.random() * 15) + 8;
    const orthoCount = Math.floor(Math.random() * 4) + 2;
    const invisCount = Math.floor(Math.random() * 6) + 3;
    const totalCount = dentistCount + orthoCount;

    // Update UI
    $('dentistCount').textContent = dentistCount;
    $('orthoCount').textContent = orthoCount;
    $('invisCount').textContent = invisCount;

    // Calculate market share (assuming $2500/mo spend vs estimated competitor spend)
    const estimatedCompetitorSpend = invisCount * 1800; // $1800 avg per competitor
    const ourSpend = 2500;
    const marketShare = Math.round((ourSpend / (ourSpend + estimatedCompetitorSpend)) * 100);
    $('marketShare').textContent = `${marketShare}%`;

    // Density analysis
    const areaSqMi = Math.PI * miles * miles;
    const density = totalCount / areaSqMi;
    const badge = $('densityBadge');
    let cls='med', label='Competitive';
    if(density <= 0.8){ cls='low'; label='Underserved market'; }
    else if(density >= 1.8){ cls='high'; label='Saturated market'; }
    badge.className = `badge ${cls}`;
    badge.textContent = `Market Density ‚Äî ${label} ‚Ä¢ ${density.toFixed(1)}/mi¬≤`;

    $('nearestMeta').textContent = `Estimated competitor ad spend: $${estimatedCompetitorSpend.toLocaleString()}/mo in radius`;

    return {
      totalCompetitors: totalCount,
      dentists: dentistCount,
      orthodontists: orthoCount,
      invisalignAds: invisCount,
      density,
      marketShare,
      competitorSpend: estimatedCompetitorSpend
    };
  }

  async function updateROIForecast(analysis, miles){
    // ROI calculation based on market size and competition
    const areaSqMi = Math.PI * miles * miles;
    const populationDensity = 2800; // avg people per sq mile in metros
    const totalPopulation = areaSqMi * populationDensity;
    const targetDemographic = totalPopulation * 0.32; // adults 25-55 with dental insurance
    
    // Market adoption rate based on competition density
    let adoptionRate = 0.024; // 2.4% base
    if(analysis.density < 0.8) adoptionRate = 0.032; // less competition
    if(analysis.density > 1.8) adoptionRate = 0.016; // high competition
    
    const potentialCases = Math.floor(targetDemographic * adoptionRate);
    const ourMarketShare = analysis.marketShare / 100;
    const monthlyCases = Math.floor((potentialCases * ourMarketShare) / 12);
    const avgCaseValue = 4800; // average Invisalign case value
    const monthlyRevenue = monthlyCases * avgCaseValue;
    const adSpend = 2500;
    const monthlyProfit = monthlyRevenue - adSpend;
    const roiMultiple = monthlyProfit / adSpend;
    
    // Update UI
    $('monthlyCases').textContent = monthlyCases;
    $('monthlyProfit').textContent = `$${monthlyProfit.toLocaleString()}`;
    $('roiMultiple').textContent = `${roiMultiple.toFixed(1)}x`;
    $('breakEven').textContent = monthlyProfit > 0 ? '< 30 days' : 'Need optimization';
  }

  async function generateAIInsights(place, analysis, miles){
    // Enhanced AI prompt for territory analysis
    const payload = {
      name: place.name || '',
      address: place.formatted_address || '',
      lat: place.geometry.location.lat(),
      lon: place.geometry.location.lng(),
      radius: miles,
      territory_analysis: {
        total_competitors: analysis.totalCompetitors,
        dentists: analysis.dentists,
        orthodontists: analysis.orthodontists,
        invisalign_ads: analysis.invisalignAds,
        market_density: analysis.density,
        market_share: analysis.marketShare,
        competitor_spend: analysis.competitorSpend,
        estimated_monthly_cases: parseInt($('monthlyCases').textContent) || 0,
        estimated_monthly_profit: $('monthlyProfit').textContent,
        roi_multiple: $('roiMultiple').textContent
      }
    };

    try{
      const res = await fetch('/api/generate-insight', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      
      if(!res.ok){
        // Fallback AI analysis if API fails
        $('ai').textContent = generateFallbackInsight(place, analysis);
      } else {
        const data = await res.json();
        $('ai').textContent = data.insight || generateFallbackInsight(place, analysis);
      }
    }catch(err){
      $('ai').textContent = generateFallbackInsight(place, analysis);
    }finally{
      $('ai').classList.remove('loading');
    }
  }

  function generateFallbackInsight(place, analysis){
    const practiceName = place.name || 'This practice';
    const density = analysis.density;
    const marketShare = analysis.marketShare;
    const cases = parseInt($('monthlyCases').textContent) || 0;
    
    let opportunity = "moderate";
    let reasoning = "balanced competitive landscape";
    
    if(density < 0.8){
      opportunity = "exceptional";
      reasoning = "underserved market with limited competition";
    } else if(density > 1.8){
      opportunity = "challenging but viable";
      reasoning = "saturated market requiring strong differentiation";
    }
    
    return `${practiceName} sits in an ${opportunity} territory for Invisalign growth. With ${analysis.invisalignAds} competitors actively advertising and a ${marketShare}% projected market share, this location could generate approximately ${cases} new Invisalign cases monthly.

The ${reasoning} suggests focusing on premium positioning and actor-led video content to capture the ${marketShare}% market opportunity. At current competition levels, a $2,500 monthly investment should yield strong returns within 30 days.

Key advantage: Once locked, no other practices in this 10-mile radius can access our proprietary video ad system, creating a sustainable competitive moat.`;
  }

  // ---------- Paginated Search Functions (from original)
  function nearbyPaged(opts, max = 60){
    return new Promise((resolve) => {
      const acc = [];
      let resolved = false;
      const cb = (results, status, pagination) => {
        if (status !== google.maps.places.PlacesServiceStatus.OK || !Array.isArray(results)) {
          if (!resolved) resolve(acc);
          return;
        }
        acc.push(...results);
        if (pagination && pagination.hasNextPage && acc.length < max) {
          setTimeout(() => pagination.nextPage(), 1200);
        } else if (!resolved) {
          resolved = true;
          resolve(acc.slice(0, max));
        }
      };
      placesService.nearbySearch(opts, cb);
    });
  }

  function textSearchPaged(opts, max = 40){
    return new Promise((resolve) => {
      const acc = [];
      let resolved = false;
      const cb = (results, status, pagination) => {
        if (status !== google.maps.places.PlacesServiceStatus.OK || !Array.isArray(results)) {
          if (!resolved) resolve(acc);
          return;
        }
        acc.push(...results);
        if (pagination && pagination.hasNextPage && acc.length < max) {
          setTimeout(() => pagination.nextPage(), 1200);
        } else if (!resolved) {
          resolved = true;
          resolve(acc.slice(0, max));
        }
      };
      placesService.textSearch(opts, cb);
    });
  }

  function openInfo(marker, place){
    const r = (place.rating != null) ? `${place.rating}‚òÖ` : 'n/a';
    const n = (place.user_ratings_total != null) ? `(${place.user_ratings_total})` : '';
    const html = `<div style="min-width:200px">
        <div style="font-weight:700;margin-bottom:4px">${place.name || 'Practice'}</div>
        <div style="opacity:.85">Google rating: ${r} ${n}</div>
      </div>`;
    infoWin.setContent(html);
    infoWin.open({ map, anchor: marker });
  }

  // ---------- Initialize territory counter animation
  function animateTerritoryCounter(){
    const counter = $('territoriesLeft');
    setInterval(()=>{
      const current = parseInt(counter.textContent.match(/\d+/)[0]);
      if(current > 3 && Math.random() < 0.1){ // 10% chance every interval
        counter.textContent = `${current - 1} founding territories remaining nationwide`;
        
        // Add urgency messaging
        if(current <= 5){
          counter.parentElement.style.background = 'rgba(239,68,68,.18)';
          counter.parentElement.style.borderColor = 'rgba(239,68,68,.35)';
        }
      }
    }, 15000); // Check every 15 seconds
  }

  // Start the counter animation when page loads
  setTimeout(animateTerritoryCounter, 5000);
  </script>
</body>
</html>
